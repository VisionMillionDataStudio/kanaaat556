# é’¢ç´¢ç¼ºé™·æ£€æµ‹æ£€æµ‹ç³»ç»Ÿæºç åˆ†äº«
 # [ä¸€æ¡é¾™æ•™å­¦YOLOV8æ ‡æ³¨å¥½çš„æ•°æ®é›†ä¸€é”®è®­ç»ƒ_70+å…¨å¥—æ”¹è¿›åˆ›æ–°ç‚¹å‘åˆŠ_Webå‰ç«¯å±•ç¤º]

### 1.ç ”ç©¶èƒŒæ™¯ä¸æ„ä¹‰

é¡¹ç›®å‚è€ƒ[AAAI Association for the Advancement of Artificial Intelligence](https://gitee.com/qunshansj/projects)

é¡¹ç›®æ¥æº[AACV Association for the Advancement of Computer Vision](https://gitee.com/qunmasj/projects)

ç ”ç©¶èƒŒæ™¯ä¸æ„ä¹‰

éšç€ç°ä»£å·¥ç¨‹æŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼Œé’¢ç´¢ä½œä¸ºæ¡¥æ¢ã€å»ºç­‘ç‰©åŠå…¶ä»–ç»“æ„çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå…¶å®‰å…¨æ€§å’Œå¯é æ€§ç›´æ¥å…³ç³»åˆ°å…¬å…±å®‰å…¨å’Œç»æµæ•ˆç›Šã€‚ç„¶è€Œï¼Œé’¢ç´¢åœ¨é•¿æœŸä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¸¸å¸¸ä¼šå—åˆ°ç¯å¢ƒå› ç´ ã€è´Ÿè½½å˜åŒ–ä»¥åŠææ–™ç–²åŠ³ç­‰å¤šç§å› ç´ çš„å½±å“ï¼Œå¯¼è‡´å‡ºç°ä¸åŒç±»å‹çš„ç¼ºé™·ï¼Œå¦‚æ–­è£‚ã€ç£¨æŸå’Œè…èš€ç­‰ã€‚è¿™äº›ç¼ºé™·ä¸ä»…å½±å“é’¢ç´¢çš„æ‰¿è½½èƒ½åŠ›ï¼Œè¿˜å¯èƒ½å¼•å‘ä¸¥é‡çš„å®‰å…¨äº‹æ•…ã€‚å› æ­¤ï¼ŒåŠæ—¶ã€å‡†ç¡®åœ°æ£€æµ‹é’¢ç´¢ç¼ºé™·ï¼Œå¯¹äºä¿éšœå·¥ç¨‹ç»“æ„çš„å®‰å…¨æ€§è‡³å…³é‡è¦ã€‚

ä¼ ç»Ÿçš„é’¢ç´¢ç¼ºé™·æ£€æµ‹æ–¹æ³•ä¸»è¦ä¾èµ–äººå·¥æ£€æŸ¥å’Œç®€å•çš„ä»ªå™¨æ£€æµ‹ï¼Œè¿™äº›æ–¹æ³•ä¸ä»…æ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”å®¹æ˜“å—åˆ°äººä¸ºå› ç´ çš„å½±å“ï¼Œå¯¼è‡´æ¼æ£€æˆ–è¯¯æ£€ã€‚éšç€è®¡ç®—æœºè§†è§‰å’Œæ·±åº¦å­¦ä¹ æŠ€æœ¯çš„è¿…é€Ÿå‘å±•ï¼ŒåŸºäºå›¾åƒå¤„ç†çš„è‡ªåŠ¨åŒ–æ£€æµ‹æ–¹æ³•é€æ¸æˆä¸ºç ”ç©¶çš„çƒ­ç‚¹ã€‚YOLOï¼ˆYou Only Look Onceï¼‰ç³»åˆ—æ¨¡å‹å› å…¶é«˜æ•ˆçš„å®æ—¶ç›®æ ‡æ£€æµ‹èƒ½åŠ›ï¼Œå·²è¢«å¹¿æ³›åº”ç”¨äºå„ç±»ç‰©ä½“æ£€æµ‹ä»»åŠ¡ä¸­ã€‚ç‰¹åˆ«æ˜¯YOLOv8ä½œä¸ºè¯¥ç³»åˆ—çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå‡­å€Ÿå…¶æ›´ä¸ºç²¾ç¡®çš„æ£€æµ‹èƒ½åŠ›å’Œæ›´å¿«çš„æ¨ç†é€Ÿåº¦ï¼Œä¸ºé’¢ç´¢ç¼ºé™·æ£€æµ‹æä¾›äº†æ–°çš„æŠ€æœ¯è·¯å¾„ã€‚

æœ¬ç ”ç©¶æ—¨åœ¨åŸºäºæ”¹è¿›çš„YOLOv8æ¨¡å‹ï¼Œæ„å»ºä¸€ä¸ªé«˜æ•ˆçš„é’¢ç´¢ç¼ºé™·æ£€æµ‹ç³»ç»Ÿã€‚æˆ‘ä»¬å°†åˆ©ç”¨åŒ…å«4300å¼ å›¾åƒçš„æ•°æ®é›†ï¼Œæ•°æ®é›†ä¸­æ¶µç›–äº†ä¸‰ç±»é’¢ç´¢ç¼ºé™·ï¼šæ–­è£‚ï¼ˆbreakï¼‰ã€é›·å‡»ï¼ˆthunderboltï¼‰å’Œç£¨æŸï¼ˆwearï¼‰ã€‚è¿™äº›ç±»åˆ«çš„ç»†åˆ†ä¸ä»…æœ‰åŠ©äºæé«˜æ£€æµ‹çš„å‡†ç¡®æ€§ï¼Œä¹Ÿä¸ºåç»­çš„ç¼ºé™·åˆ†æå’Œå¤„ç†æä¾›äº†æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯ã€‚é€šè¿‡å¯¹æ•°æ®é›†çš„æ·±å…¥åˆ†æå’Œæ¨¡å‹çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬æœŸæœ›èƒ½å¤Ÿæå‡ç³»ç»Ÿåœ¨å®é™…åº”ç”¨ä¸­çš„é²æ£’æ€§å’Œé€‚åº”æ€§ã€‚

æœ¬ç ”ç©¶çš„æ„ä¹‰åœ¨äºï¼Œé¦–å…ˆï¼Œåˆ©ç”¨æ”¹è¿›çš„YOLOv8æ¨¡å‹è¿›è¡Œé’¢ç´¢ç¼ºé™·æ£€æµ‹ï¼Œå¯ä»¥æ˜¾è‘—æé«˜æ£€æµ‹çš„æ•ˆç‡å’Œå‡†ç¡®æ€§ï¼Œå‡å°‘äººå·¥æ£€æŸ¥çš„å·¥ä½œé‡ï¼Œä»è€Œé™ä½äººåŠ›æˆæœ¬å’Œæ—¶é—´æˆæœ¬ã€‚å…¶æ¬¡ï¼ŒåŸºäºæ·±åº¦å­¦ä¹ çš„æ£€æµ‹ç³»ç»Ÿèƒ½å¤Ÿå®æ—¶ç›‘æµ‹é’¢ç´¢çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°æ½œåœ¨çš„å®‰å…¨éšæ‚£ï¼Œä¸ºå·¥ç¨‹ç»´æŠ¤æä¾›ç§‘å­¦ä¾æ®ï¼Œè¿›è€Œæé«˜å·¥ç¨‹ç»“æ„çš„å®‰å…¨æ€§ã€‚æ­¤å¤–ï¼Œæœ¬ç ”ç©¶è¿˜å°†ä¸ºé’¢ç´¢ç¼ºé™·æ£€æµ‹é¢†åŸŸæä¾›æ–°çš„æ€è·¯å’Œæ–¹æ³•ï¼Œæ¨åŠ¨ç›¸å…³æŠ€æœ¯çš„å‘å±•ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒåŸºäºæ”¹è¿›YOLOv8çš„é’¢ç´¢ç¼ºé™·æ£€æµ‹ç³»ç»Ÿçš„ç ”ç©¶ï¼Œä¸ä»…å…·æœ‰é‡è¦çš„ç†è®ºä»·å€¼ï¼Œä¹Ÿå…·å¤‡å¹¿æ³›çš„å®é™…åº”ç”¨å‰æ™¯ã€‚é€šè¿‡å¯¹é’¢ç´¢ç¼ºé™·çš„è‡ªåŠ¨åŒ–æ£€æµ‹ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿä¸ºå·¥ç¨‹å®‰å…¨ç®¡ç†æä¾›æ›´ä¸ºé«˜æ•ˆã€å¯é çš„æŠ€æœ¯æ”¯æŒï¼Œä¿ƒè¿›å·¥ç¨‹å»ºè®¾çš„å¯æŒç»­å‘å±•ã€‚

### 2.å›¾ç‰‡æ¼”ç¤º

![1.png](1.png)

![2.png](2.png)

![3.png](3.png)

##### æ³¨æ„ï¼šç”±äºæ­¤åšå®¢ç¼–è¾‘è¾ƒæ—©ï¼Œä¸Šé¢â€œ2.å›¾ç‰‡æ¼”ç¤ºâ€å’Œâ€œ3.è§†é¢‘æ¼”ç¤ºâ€å±•ç¤ºçš„ç³»ç»Ÿå›¾ç‰‡æˆ–è€…è§†é¢‘å¯èƒ½ä¸ºè€ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬åœ¨è€ç‰ˆæœ¬çš„åŸºç¡€ä¸Šå‡çº§å¦‚ä¸‹ï¼šï¼ˆå®é™…æ•ˆæœä»¥å‡çº§çš„æ–°ç‰ˆæœ¬ä¸ºå‡†ï¼‰

  ï¼ˆ1ï¼‰é€‚é…äº†YOLOV8çš„â€œç›®æ ‡æ£€æµ‹â€æ¨¡å‹å’Œâ€œå®ä¾‹åˆ†å‰²â€æ¨¡å‹ï¼Œé€šè¿‡åŠ è½½ç›¸åº”çš„æƒé‡ï¼ˆ.ptï¼‰æ–‡ä»¶å³å¯è‡ªé€‚åº”åŠ è½½æ¨¡å‹ã€‚

  ï¼ˆ2ï¼‰æ”¯æŒâ€œå›¾ç‰‡è¯†åˆ«â€ã€â€œè§†é¢‘è¯†åˆ«â€ã€â€œæ‘„åƒå¤´å®æ—¶è¯†åˆ«â€ä¸‰ç§è¯†åˆ«æ¨¡å¼ã€‚

  ï¼ˆ3ï¼‰æ”¯æŒâ€œå›¾ç‰‡è¯†åˆ«â€ã€â€œè§†é¢‘è¯†åˆ«â€ã€â€œæ‘„åƒå¤´å®æ—¶è¯†åˆ«â€ä¸‰ç§è¯†åˆ«ç»“æœä¿å­˜å¯¼å‡ºï¼Œè§£å†³æ‰‹åŠ¨å¯¼å‡ºï¼ˆå®¹æ˜“å¡é¡¿å‡ºç°çˆ†å†…å­˜ï¼‰å­˜åœ¨çš„é—®é¢˜ï¼Œè¯†åˆ«å®Œè‡ªåŠ¨ä¿å­˜ç»“æœå¹¶å¯¼å‡ºåˆ°tempDirä¸­ã€‚

  ï¼ˆ4ï¼‰æ”¯æŒWebå‰ç«¯ç³»ç»Ÿä¸­çš„æ ‡é¢˜ã€èƒŒæ™¯å›¾ç­‰è‡ªå®šä¹‰ä¿®æ”¹ï¼Œåé¢æä¾›ä¿®æ”¹æ•™ç¨‹ã€‚

  å¦å¤–æœ¬é¡¹ç›®æä¾›è®­ç»ƒçš„æ•°æ®é›†å’Œè®­ç»ƒæ•™ç¨‹,æš‚ä¸æä¾›æƒé‡æ–‡ä»¶ï¼ˆbest.ptï¼‰,éœ€è¦æ‚¨æŒ‰ç…§æ•™ç¨‹è¿›è¡Œè®­ç»ƒåå®ç°å›¾ç‰‡æ¼”ç¤ºå’ŒWebå‰ç«¯ç•Œé¢æ¼”ç¤ºçš„æ•ˆæœã€‚

### 3.è§†é¢‘æ¼”ç¤º

[3.1 è§†é¢‘æ¼”ç¤º](https://www.bilibili.com/video/BV1xStjeQEJp/)

### 4.æ•°æ®é›†ä¿¡æ¯å±•ç¤º

##### 4.1 æœ¬é¡¹ç›®æ•°æ®é›†è¯¦ç»†æ•°æ®ï¼ˆç±»åˆ«æ•°ï¼†ç±»åˆ«åï¼‰

nc: 3
names: ['break', 'thunderbolt', 'wear']


##### 4.2 æœ¬é¡¹ç›®æ•°æ®é›†ä¿¡æ¯ä»‹ç»

æ•°æ®é›†ä¿¡æ¯å±•ç¤º

åœ¨æœ¬ç ”ç©¶ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†åä¸ºâ€œkanaaatâ€çš„æ•°æ®é›†ï¼Œæ—¨åœ¨è®­ç»ƒå’Œæ”¹è¿›YOLOv8æ¨¡å‹ï¼Œä»¥å®ç°é«˜æ•ˆçš„é’¢ç´¢ç¼ºé™·æ£€æµ‹ã€‚è¯¥æ•°æ®é›†ä¸“é—¨é’ˆå¯¹é’¢ç´¢çš„ä¸åŒç¼ºé™·ç±»å‹è¿›è¡Œäº†ç²¾å¿ƒçš„æ ‡æ³¨å’Œæ•´ç†ï¼ŒåŒ…å«äº†ä¸‰ç§ä¸»è¦çš„ç¼ºé™·ç±»åˆ«ï¼šæ–­è£‚ï¼ˆbreakï¼‰ã€é›·å‡»ï¼ˆthunderboltï¼‰å’Œç£¨æŸï¼ˆwearï¼‰ã€‚è¿™äº›ç±»åˆ«çš„é€‰æ‹©åæ˜ äº†åœ¨å®é™…åº”ç”¨ä¸­é’¢ç´¢å¯èƒ½é¢ä¸´çš„å¸¸è§é—®é¢˜ï¼Œå…·æœ‰é‡è¦çš„å®ç”¨ä»·å€¼å’Œç ”ç©¶æ„ä¹‰ã€‚

â€œkanaaatâ€æ•°æ®é›†çš„æ„å»ºè¿‡ç¨‹ç»è¿‡äº†ä¸¥æ ¼çš„æ ‡å‡†åŒ–å’ŒéªŒè¯ï¼Œç¡®ä¿äº†æ•°æ®çš„è´¨é‡å’Œæ ‡æ³¨çš„å‡†ç¡®æ€§ã€‚æ¯ä¸ªç±»åˆ«çš„æ ·æœ¬å‡ç»è¿‡ç²¾å¿ƒæŒ‘é€‰ï¼Œæ¶µç›–äº†å¤šç§ç¯å¢ƒå’Œæ¡ä»¶ä¸‹çš„é’¢ç´¢å›¾åƒï¼Œä»¥æé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚æ•°æ®é›†ä¸­åŒ…å«çš„å›¾åƒæ•°é‡å’Œå¤šæ ·æ€§ï¼Œä½¿å¾—æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­èƒ½å¤Ÿå­¦ä¹ åˆ°ä¸°å¯Œçš„ç‰¹å¾ï¼Œä»è€Œæ›´å¥½åœ°è¯†åˆ«å’Œåˆ†ç±»ä¸åŒç±»å‹çš„ç¼ºé™·ã€‚

åœ¨â€œkanaaatâ€æ•°æ®é›†ä¸­ï¼Œæ–­è£‚ï¼ˆbreakï¼‰ç±»åˆ«ä¸»è¦åŒ…æ‹¬äº†ç”±äºè¿‡è½½ã€ç–²åŠ³æˆ–ææ–™è€åŒ–ç­‰åŸå› å¯¼è‡´çš„é’¢ç´¢æ–­è£‚çš„å›¾åƒã€‚è¿™äº›å›¾åƒå±•ç¤ºäº†ä¸åŒè§’åº¦å’Œå…‰ç…§æ¡ä»¶ä¸‹çš„æ–­è£‚ç‰¹å¾ï¼Œä¸ºæ¨¡å‹æä¾›äº†å¤šæ ·åŒ–çš„å­¦ä¹ æ ·æœ¬ã€‚é›·å‡»ï¼ˆthunderboltï¼‰ç±»åˆ«åˆ™åŒ…å«äº†å› é›·ç”µå‡»ä¸­è€Œå¯¼è‡´çš„é’¢ç´¢æŸä¼¤çš„å›¾åƒï¼Œè¿™ç±»ç¼ºé™·åœ¨æŸäº›åœ°åŒºçš„é’¢ç´¢ç»´æŠ¤ä¸­å°¤ä¸ºé‡è¦ï¼ŒåŠæ—¶çš„æ£€æµ‹èƒ½å¤Ÿæœ‰æ•ˆé¿å…æ½œåœ¨çš„å®‰å…¨éšæ‚£ã€‚ç£¨æŸï¼ˆwearï¼‰ç±»åˆ«åˆ™é›†ä¸­åœ¨é’¢ç´¢åœ¨é•¿æœŸä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œç”±äºæ‘©æ“¦å’Œç¯å¢ƒå› ç´ é€ æˆçš„è¡¨é¢ç£¨æŸç°è±¡ã€‚è¿™ç§ç£¨æŸä¸ä»…å½±å“é’¢ç´¢çš„å¼ºåº¦å’Œè€ç”¨æ€§ï¼Œè¿˜å¯èƒ½å¯¼è‡´æ›´ä¸¥é‡çš„ç»“æ„æ€§é—®é¢˜ï¼Œå› æ­¤å…¶æ£€æµ‹å’Œç›‘æµ‹æ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚

ä¸ºäº†ç¡®ä¿æ¨¡å‹çš„è®­ç»ƒæ•ˆæœï¼Œæ•°æ®é›†çš„åˆ’åˆ†ä¹Ÿç»è¿‡äº†ç²¾å¿ƒè®¾è®¡ï¼Œé€šå¸¸åŒ…æ‹¬è®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†çš„åˆ†é…ã€‚è¿™æ ·çš„åˆ’åˆ†ä¸ä»…æœ‰åŠ©äºæ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è¿›è¡Œæœ‰æ•ˆçš„å­¦ä¹ ï¼Œè¿˜èƒ½åœ¨éªŒè¯å’Œæµ‹è¯•é˜¶æ®µæä¾›å®¢è§‚çš„æ€§èƒ½è¯„ä¼°ã€‚é€šè¿‡å¯¹â€œkanaaatâ€æ•°æ®é›†çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬æœŸæœ›èƒ½å¤Ÿæå‡YOLOv8åœ¨é’¢ç´¢ç¼ºé™·æ£€æµ‹ä»»åŠ¡ä¸­çš„å‡†ç¡®æ€§å’Œé²æ£’æ€§ã€‚

æ­¤å¤–ï¼Œæ•°æ®é›†çš„å¤šæ ·æ€§å’Œä¸°å¯Œæ€§ä¹Ÿä¸ºåç»­çš„ç ”ç©¶æä¾›äº†è‰¯å¥½çš„åŸºç¡€ã€‚ç ”ç©¶äººå‘˜å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ›´æ·±å…¥çš„åˆ†æï¼Œæ¢ç´¢ä¸åŒç¼ºé™·ç±»å‹ä¹‹é—´çš„å…³è”æ€§ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡æ”¹è¿›ç®—æ³•æ¥è¿›ä¸€æ­¥æå‡æ£€æµ‹çš„æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚éšç€å¯¹é’¢ç´¢ç¼ºé™·æ£€æµ‹éœ€æ±‚çš„ä¸æ–­å¢åŠ ï¼Œåƒâ€œkanaaatâ€è¿™æ ·çš„æ•°æ®é›†å°†å‘æŒ¥è¶Šæ¥è¶Šé‡è¦çš„ä½œç”¨ï¼Œæ¨åŠ¨ç›¸å…³é¢†åŸŸçš„æŠ€æœ¯è¿›æ­¥å’Œåº”ç”¨åˆ›æ–°ã€‚

æ€»ä¹‹ï¼Œâ€œkanaaatâ€æ•°æ®é›†ä¸ä»…ä¸ºYOLOv8æ¨¡å‹çš„è®­ç»ƒæä¾›äº†åšå®çš„åŸºç¡€ï¼Œä¹Ÿä¸ºé’¢ç´¢ç¼ºé™·æ£€æµ‹æŠ€æœ¯çš„å‘å±•å¼€è¾Ÿäº†æ–°çš„æ–¹å‘ã€‚é€šè¿‡å¯¹è¯¥æ•°æ®é›†çš„æ·±å…¥ç ”ç©¶å’Œåº”ç”¨ï¼Œæˆ‘ä»¬æœ‰æœ›åœ¨é’¢ç´¢å®‰å…¨ç›‘æµ‹é¢†åŸŸå–å¾—æ›´ä¸ºæ˜¾è‘—çš„æˆæœï¼Œä¸ºå·¥ç¨‹å®‰å…¨å’Œç»´æŠ¤æä¾›æœ‰åŠ›çš„æŠ€æœ¯æ”¯æŒã€‚

![4.png](4.png)

![5.png](5.png)

![6.png](6.png)

![7.png](7.png)

![8.png](8.png)

### 5.å…¨å¥—é¡¹ç›®ç¯å¢ƒéƒ¨ç½²è§†é¢‘æ•™ç¨‹ï¼ˆé›¶åŸºç¡€æ‰‹æŠŠæ‰‹æ•™å­¦ï¼‰

[5.1 ç¯å¢ƒéƒ¨ç½²æ•™ç¨‹é“¾æ¥ï¼ˆé›¶åŸºç¡€æ‰‹æŠŠæ‰‹æ•™å­¦ï¼‰](https://www.ixigua.com/7404473917358506534?logTag=c807d0cbc21c0ef59de5)




[5.2 å®‰è£…Pythonè™šæ‹Ÿç¯å¢ƒåˆ›å»ºå’Œä¾èµ–åº“å®‰è£…è§†é¢‘æ•™ç¨‹é“¾æ¥ï¼ˆé›¶åŸºç¡€æ‰‹æŠŠæ‰‹æ•™å­¦ï¼‰](https://www.ixigua.com/7404474678003106304?logTag=1f1041108cd1f708b01a)

### 6.æ‰‹æŠŠæ‰‹YOLOV8è®­ç»ƒè§†é¢‘æ•™ç¨‹ï¼ˆé›¶åŸºç¡€å°ç™½æœ‰æ‰‹å°±èƒ½å­¦ä¼šï¼‰

[6.1 æ‰‹æŠŠæ‰‹YOLOV8è®­ç»ƒè§†é¢‘æ•™ç¨‹ï¼ˆé›¶åŸºç¡€å°ç™½æœ‰æ‰‹å°±èƒ½å­¦ä¼šï¼‰](https://www.ixigua.com/7404477157818401292?logTag=d31a2dfd1983c9668658)

### 7.70+ç§å…¨å¥—YOLOV8åˆ›æ–°ç‚¹ä»£ç åŠ è½½è°ƒå‚è§†é¢‘æ•™ç¨‹ï¼ˆä¸€é”®åŠ è½½å†™å¥½çš„æ”¹è¿›æ¨¡å‹çš„é…ç½®æ–‡ä»¶ï¼‰

[7.1 70+ç§å…¨å¥—YOLOV8åˆ›æ–°ç‚¹ä»£ç åŠ è½½è°ƒå‚è§†é¢‘æ•™ç¨‹ï¼ˆä¸€é”®åŠ è½½å†™å¥½çš„æ”¹è¿›æ¨¡å‹çš„é…ç½®æ–‡ä»¶ï¼‰](https://www.ixigua.com/7404478314661806627?logTag=29066f8288e3f4eea3a4)

### 8.70+ç§å…¨å¥—YOLOV8åˆ›æ–°ç‚¹åŸç†è®²è§£ï¼ˆéç§‘ç­ä¹Ÿå¯ä»¥è½»æ¾å†™åˆŠå‘åˆŠï¼ŒV10ç‰ˆæœ¬æ­£åœ¨ç§‘ç ”å¾…æ›´æ–°ï¼‰

ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæ¯ä¸ªåˆ›æ–°ç‚¹çš„å…·ä½“åŸç†è®²è§£å°±ä¸ä¸€ä¸€å±•å¼€ï¼Œå…·ä½“è§ä¸‹åˆ—ç½‘å€ä¸­çš„åˆ›æ–°ç‚¹å¯¹åº”å­é¡¹ç›®çš„æŠ€æœ¯åŸç†åšå®¢ç½‘å€ã€Blogã€‘ï¼š

![9.png](9.png)

[8.1 70+ç§å…¨å¥—YOLOV8åˆ›æ–°ç‚¹åŸç†è®²è§£é“¾æ¥](https://gitee.com/qunmasj/good)

### 9.ç³»ç»ŸåŠŸèƒ½å±•ç¤ºï¼ˆæ£€æµ‹å¯¹è±¡ä¸ºä¸¾ä¾‹ï¼Œå®é™…å†…å®¹ä»¥æœ¬é¡¹ç›®æ•°æ®é›†ä¸ºå‡†ï¼‰

å›¾9.1.ç³»ç»Ÿæ”¯æŒæ£€æµ‹ç»“æœè¡¨æ ¼æ˜¾ç¤º

  å›¾9.2.ç³»ç»Ÿæ”¯æŒç½®ä¿¡åº¦å’ŒIOUé˜ˆå€¼æ‰‹åŠ¨è°ƒèŠ‚

  å›¾9.3.ç³»ç»Ÿæ”¯æŒè‡ªå®šä¹‰åŠ è½½æƒé‡æ–‡ä»¶best.pt(éœ€è¦ä½ é€šè¿‡æ­¥éª¤5ä¸­è®­ç»ƒè·å¾—)

  å›¾9.4.ç³»ç»Ÿæ”¯æŒæ‘„åƒå¤´å®æ—¶è¯†åˆ«

  å›¾9.5.ç³»ç»Ÿæ”¯æŒå›¾ç‰‡è¯†åˆ«

  å›¾9.6.ç³»ç»Ÿæ”¯æŒè§†é¢‘è¯†åˆ«

  å›¾9.7.ç³»ç»Ÿæ”¯æŒè¯†åˆ«ç»“æœæ–‡ä»¶è‡ªåŠ¨ä¿å­˜

  å›¾9.8.ç³»ç»Ÿæ”¯æŒExcelå¯¼å‡ºæ£€æµ‹ç»“æœæ•°æ®

![10.png](10.png)

![11.png](11.png)

![12.png](12.png)

![13.png](13.png)

![14.png](14.png)

![15.png](15.png)

![16.png](16.png)

![17.png](17.png)

### 10.åŸå§‹YOLOV8ç®—æ³•åŸç†

åŸå§‹YOLOv8ç®—æ³•åŸç†

YOLOv8æ˜¯ç”±Ultralyticså…¬å¸äº2023å¹´å‘å¸ƒçš„æœ€æ–°ä¸€ä»£YOLOç³»åˆ—ç®—æ³•ï¼Œå…¶è®¾è®¡ç†å¿µæ—¨åœ¨è¿›ä¸€æ­¥æå‡ç›®æ ‡æ£€æµ‹çš„ç²¾åº¦å’Œé€Ÿåº¦ã€‚ä½œä¸ºYOLOç³»åˆ—çš„å»¶ç»­ï¼ŒYOLOv8ä¸ä»…åœ¨æ¶æ„ä¸Šè¿›è¡Œäº†åˆ›æ–°ï¼Œè¿˜åœ¨åŠŸèƒ½ä¸Šæ‰©å±•äº†åº”ç”¨åœºæ™¯ï¼Œæˆä¸ºè®¡ç®—æœºè§†è§‰é¢†åŸŸä¸­æœ€å…ˆè¿›çš„æ¨¡å‹ä¹‹ä¸€ã€‚æœ¬æ–‡å°†é‡ç‚¹æ¢è®¨YOLOv8nçš„åŸå§‹ç®—æ³•åŸç†ï¼Œæ­ç¤ºå…¶åœ¨ç‰¹å¾æå–ã€ç½‘ç»œç»“æ„ã€æŸå¤±å‡½æ•°ç­‰æ–¹é¢çš„ç‹¬ç‰¹è®¾è®¡ã€‚

YOLOv8nä½œä¸ºYOLOv8ç³»åˆ—ä¸­çš„ä¸€ä¸ªè½»é‡çº§æ¨¡å‹ï¼Œé‡‡ç”¨äº†C2fæ¨¡å—æ›¿ä»£äº†YOLOv5ä¸­çš„C3æ¨¡å—ã€‚è¿™ä¸€åˆ›æ–°è®¾è®¡çš„æ ¸å¿ƒåœ¨äºC2fæ¨¡å—å¼•å…¥äº†æ›´å¤šçš„æ®‹å·®è¿æ¥ï¼Œå¢å¼ºäº†æ¢¯åº¦ä¿¡æ¯çš„ä¼ é€’èƒ½åŠ›ï¼Œä»è€Œåœ¨è½»é‡åŒ–çš„åŸºç¡€ä¸Šæå‡äº†æ¨¡å‹çš„è¡¨ç°ã€‚C2fæ¨¡å—çš„è®¾è®¡çµæ„Ÿéƒ¨åˆ†æ¥æºäºYOLOv7ä¸­çš„ELANæ¨¡å—ï¼Œé€šè¿‡ç»“åˆå¤šç§ç»“æ„çš„ä¼˜ç‚¹ï¼ŒYOLOv8nèƒ½å¤Ÿåœ¨ç‰¹å¾æå–é˜¶æ®µå®ç°æ›´é«˜æ•ˆçš„ç‰¹å¾å­¦ä¹ ã€‚

åœ¨ä¸»å¹²ç½‘ç»œæ–¹é¢ï¼ŒYOLOv8né‡‡ç”¨äº†CSPï¼ˆCross Stage Partialï¼‰ç»“æ„ï¼Œè¿™ç§ç»“æ„å°†ç‰¹å¾æå–è¿‡ç¨‹åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«è¿›è¡Œå·ç§¯å’Œè¿æ¥ã€‚è¿™ç§åˆ†ç¦»çš„è®¾è®¡ä½¿å¾—ç½‘ç»œåœ¨å¤„ç†ç‰¹å¾æ—¶èƒ½å¤Ÿæ›´çµæ´»åœ°é€‰æ‹©å’Œç»„åˆä¿¡æ¯ï¼Œè¿›è€Œæé«˜äº†æ¨¡å‹çš„æ•´ä½“æ€§èƒ½ã€‚CSPç»“æ„çš„å¼•å…¥ä¸ä»…å¢å¼ºäº†ç½‘ç»œçš„è¡¨è¾¾èƒ½åŠ›ï¼Œè¿˜æœ‰æ•ˆåœ°é™ä½äº†è®¡ç®—å¤æ‚åº¦ï¼Œä½¿å¾—YOLOv8nåœ¨å®æ—¶æ£€æµ‹ä»»åŠ¡ä¸­è¡¨ç°å‡ºè‰²ã€‚

YOLOv8nçš„é¢ˆéƒ¨ç½‘ç»œé‡‡ç”¨äº†PAN-FPNï¼ˆPath Aggregation Network - Feature Pyramid Networkï¼‰ç»“æ„ï¼Œè¿™ä¸€ç»“æ„åœ¨ç‰¹å¾å¤šå°ºåº¦èåˆæ–¹é¢è¡¨ç°ä¼˜å¼‚ã€‚PAN-FPNé€šè¿‡è‡ªä¸‹è€Œä¸Šçš„è·¯å¾„å’Œè‡ªä¸Šè€Œä¸‹çš„è·¯å¾„ç›¸ç»“åˆï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°æ•´åˆä¸åŒå°ºåº¦çš„ç‰¹å¾ä¿¡æ¯ï¼Œæå‡äº†å°ç›®æ ‡çš„æ£€æµ‹èƒ½åŠ›ã€‚ç›¸è¾ƒäºä¼ ç»Ÿçš„ç‰¹å¾èåˆæ–¹æ³•ï¼ŒPAN-FPNçš„è®¾è®¡æ›´ä¸ºçµæ´»ï¼Œèƒ½å¤Ÿé€‚åº”ä¸åŒåœºæ™¯ä¸‹çš„éœ€æ±‚ã€‚

åœ¨æ£€æµ‹ç½‘ç»œçš„è®¾è®¡ä¸Šï¼ŒYOLOv8né‡‡ç”¨äº†Anchor-Freeçš„æ£€æµ‹æ–¹å¼ï¼Œè¿™ä¸€åˆ›æ–°ä½¿å¾—æ¨¡å‹åœ¨ç›®æ ‡æ£€æµ‹æ—¶ä¸å†ä¾èµ–äºé¢„å®šä¹‰çš„é”šæ¡†ã€‚ä¼ ç»Ÿçš„Anchor-Basedæ–¹æ³•åœ¨å¤„ç†ä¸åŒå°ºåº¦å’Œå½¢çŠ¶çš„ç›®æ ‡æ—¶å¸¸å¸¸é¢ä¸´æŒ‘æˆ˜ï¼Œè€ŒAnchor-Freeæ–¹æ³•åˆ™é€šè¿‡ç›´æ¥å›å½’ç›®æ ‡çš„è¾¹ç•Œæ¡†åæ ‡ï¼Œç®€åŒ–äº†æ£€æµ‹è¿‡ç¨‹ï¼Œæé«˜äº†æ£€æµ‹çš„å‡†ç¡®æ€§å’Œæ•ˆç‡ã€‚YOLOv8nçš„Detectæ¨¡å—ä½¿ç”¨äº†è§£è€¦å¤´ç»“æ„ï¼Œå°†åˆ†ç±»å’Œå›å½’ä»»åŠ¡åˆ†å¼€å¤„ç†ï¼Œè¿™ä¸€è®¾è®¡ä¸ä»…æé«˜äº†æ¨¡å‹çš„å¯è§£é‡Šæ€§ï¼Œè¿˜å¢å¼ºäº†æ¨¡å‹åœ¨å¤æ‚åœºæ™¯ä¸‹çš„é²æ£’æ€§ã€‚

åœ¨æŸå¤±å‡½æ•°çš„è®¾è®¡ä¸Šï¼ŒYOLOv8nå¼•å…¥äº†CloUä½œä¸ºä¸»è¦çš„æŸå¤±è®¡ç®—æ–¹å¼ï¼Œç»“åˆäº†BCELossä½œä¸ºåˆ†ç±»æŸå¤±å’ŒDFLLoss+CIoULossä½œä¸ºå›å½’æŸå¤±ã€‚è¿™ç§å¤šå…ƒåŒ–çš„æŸå¤±è®¡ç®—æ–¹å¼ä½¿å¾—æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­èƒ½å¤Ÿæ›´å¥½åœ°å¹³è¡¡åˆ†ç±»å’Œå›å½’ä»»åŠ¡çš„ä¼˜åŒ–ï¼Œè¿›è€Œæå‡äº†æ•´ä½“çš„æ£€æµ‹æ€§èƒ½ã€‚é€šè¿‡ç²¾ç»†åŒ–çš„æŸå¤±å‡½æ•°è®¾è®¡ï¼ŒYOLOv8nèƒ½å¤Ÿåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æ›´æœ‰æ•ˆåœ°æ•æ‰åˆ°ç›®æ ‡çš„ç‰¹å¾ä¿¡æ¯ï¼Œä»è€Œå®ç°æ›´é«˜çš„æ£€æµ‹ç²¾åº¦ã€‚

æ­¤å¤–ï¼ŒYOLOv8nåœ¨æ•°æ®å¢å¼ºæ–¹é¢ä¹Ÿè¿›è¡Œäº†åˆ›æ–°ï¼Œé‡‡ç”¨äº†åŠ¨æ€Task-Aligned Assigneræ ·æœ¬åˆ†é…ç­–ç•¥ï¼Œå¹¶åœ¨è®­ç»ƒçš„æœ€å10ä¸ªepochä¸­å…³é—­äº†é©¬èµ›å…‹å¢å¼ºã€‚è¿™ä¸€ç­–ç•¥çš„å®æ–½æ—¨åœ¨æå‡æ¨¡å‹å¯¹çœŸå®åœºæ™¯çš„é€‚åº”èƒ½åŠ›ï¼Œå‡å°‘è¿‡æ‹Ÿåˆç°è±¡çš„å‘ç”Ÿï¼Œä»è€Œæé«˜æ¨¡å‹åœ¨å®é™…åº”ç”¨ä¸­çš„è¡¨ç°ã€‚

æ€»çš„æ¥è¯´ï¼ŒYOLOv8né€šè¿‡å¯¹ç½‘ç»œç»“æ„çš„å¤šé¡¹åˆ›æ–°å’Œä¼˜åŒ–ï¼ŒæˆåŠŸåœ°æå‡äº†ç›®æ ‡æ£€æµ‹çš„ç²¾åº¦å’Œé€Ÿåº¦ã€‚å…¶åœ¨ç‰¹å¾æå–ã€ç½‘ç»œè®¾è®¡ã€æŸå¤±è®¡ç®—ç­‰æ–¹é¢çš„ç‹¬ç‰¹æ€è·¯ï¼Œä½¿å¾—YOLOv8nåœ¨å¤„ç†å¤æ‚åœºæ™¯å’Œå°ç›®æ ‡æ£€æµ‹æ—¶è¡¨ç°å°¤ä¸ºçªå‡ºã€‚éšç€YOLOv8çš„å‘å¸ƒï¼Œç›®æ ‡æ£€æµ‹æŠ€æœ¯è¿æ¥äº†æ–°çš„å‘å±•æœºé‡ï¼Œæœªæ¥çš„ç ”ç©¶å’Œåº”ç”¨å°†æ›´åŠ å¹¿æ³›ï¼Œæ¨åŠ¨è®¡ç®—æœºè§†è§‰é¢†åŸŸçš„è¿›ä¸€æ­¥å‘å±•ã€‚

![18.png](18.png)

### 11.é¡¹ç›®æ ¸å¿ƒæºç è®²è§£ï¼ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒçœ‹ä¸æ‡‚ä»£ç é€»è¾‘ï¼‰

#### 11.1 code\ultralytics\models\yolo\obb\val.py

ä»¥ä¸‹æ˜¯ç»è¿‡ç²¾ç®€å’Œæ³¨é‡Šçš„æ ¸å¿ƒä»£ç éƒ¨åˆ†ï¼Œä¿ç•™äº†æœ€é‡è¦çš„åŠŸèƒ½å’Œé€»è¾‘ã€‚

```python
# Ultralytics YOLO ğŸš€, AGPL-3.0 license

from pathlib import Path
import torch
from ultralytics.models.yolo.detect import DetectionValidator
from ultralytics.utils import ops
from ultralytics.utils.metrics import OBBMetrics, batch_probiou
from ultralytics.utils.plotting import output_to_rotated_target, plot_images

class OBBValidator(DetectionValidator):
    """
    OBBValidatorç±»ç”¨äºåŸºäºå®šå‘è¾¹ç•Œæ¡†ï¼ˆOBBï¼‰æ¨¡å‹çš„éªŒè¯ã€‚
    """

    def __init__(self, dataloader=None, save_dir=None, pbar=None, args=None, _callbacks=None):
        """åˆå§‹åŒ–OBBValidatorå¹¶å°†ä»»åŠ¡è®¾ç½®ä¸º'obb'ï¼ŒæŒ‡æ ‡è®¾ç½®ä¸ºOBBMetricsã€‚"""
        super().__init__(dataloader, save_dir, pbar, args, _callbacks)
        self.args.task = "obb"  # è®¾ç½®ä»»åŠ¡ç±»å‹ä¸ºOBB
        self.metrics = OBBMetrics(save_dir=self.save_dir, plot=True, on_plot=self.on_plot)  # åˆå§‹åŒ–æŒ‡æ ‡

    def postprocess(self, preds):
        """å¯¹é¢„æµ‹è¾“å‡ºåº”ç”¨éæå¤§å€¼æŠ‘åˆ¶ï¼ˆNMSï¼‰ã€‚"""
        return ops.non_max_suppression(
            preds,
            self.args.conf,  # ç½®ä¿¡åº¦é˜ˆå€¼
            self.args.iou,   # IoUé˜ˆå€¼
            labels=self.lb,
            nc=self.nc,
            multi_label=True,
            agnostic=self.args.single_cls,
            max_det=self.args.max_det,
            rotated=True,    # å¤„ç†æ—‹è½¬æ¡†
        )

    def _process_batch(self, detections, gt_bboxes, gt_cls):
        """
        è¿”å›æ­£ç¡®çš„é¢„æµ‹çŸ©é˜µã€‚

        å‚æ•°:
            detections (torch.Tensor): å½¢çŠ¶ä¸º[N, 6]çš„æ£€æµ‹å¼ é‡ï¼Œæ¯ä¸ªæ£€æµ‹æ ¼å¼ä¸º: x1, y1, x2, y2, conf, classã€‚
            gt_bboxes (torch.Tensor): å½¢çŠ¶ä¸º[M, 5]çš„æ ‡ç­¾å¼ é‡ï¼Œæ¯ä¸ªæ ‡ç­¾æ ¼å¼ä¸º: class, x1, y1, x2, y2ã€‚

        è¿”å›:
            (torch.Tensor): å½¢çŠ¶ä¸º[N, 10]çš„æ­£ç¡®é¢„æµ‹çŸ©é˜µï¼Œè¡¨ç¤º10ä¸ªIoUæ°´å¹³ã€‚
        """
        iou = batch_probiou(gt_bboxes, torch.cat([detections[:, :4], detections[:, -1:]], dim=-1))  # è®¡ç®—IoU
        return self.match_predictions(detections[:, 5], gt_cls, iou)  # åŒ¹é…é¢„æµ‹ä¸çœŸå®æ ‡ç­¾

    def plot_predictions(self, batch, preds, ni):
        """åœ¨è¾“å…¥å›¾åƒä¸Šç»˜åˆ¶é¢„æµ‹çš„è¾¹ç•Œæ¡†å¹¶ä¿å­˜ç»“æœã€‚"""
        plot_images(
            batch["img"],
            *output_to_rotated_target(preds, max_det=self.args.max_det),  # è¾“å‡ºæ—‹è½¬ç›®æ ‡
            paths=batch["im_file"],
            fname=self.save_dir / f"val_batch{ni}_pred.jpg",  # ä¿å­˜æ–‡ä»¶å
            names=self.names,
            on_plot=self.on_plot,
        )

    def eval_json(self, stats):
        """è¯„ä¼°YOLOè¾“å‡ºçš„JSONæ ¼å¼å¹¶è¿”å›æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯ã€‚"""
        if self.args.save_json and len(self.jdict):
            import json
            from collections import defaultdict

            pred_json = self.save_dir / "predictions.json"  # é¢„æµ‹ç»“æœæ–‡ä»¶
            pred_txt = self.save_dir / "predictions_txt"  # æ–‡æœ¬é¢„æµ‹ç»“æœç›®å½•
            pred_txt.mkdir(parents=True, exist_ok=True)  # åˆ›å»ºç›®å½•
            data = json.load(open(pred_json))  # åŠ è½½JSONæ•°æ®

            # ä¿å­˜åˆ†å‰²ç»“æœ
            for d in data:
                image_id = d["image_id"]
                score = d["score"]
                classname = self.names[d["category_id"]].replace(" ", "-")
                p = d["poly"]

                with open(f'{pred_txt / f"Task1_{classname}"}.txt', "a") as f:
                    f.writelines(f"{image_id} {score} {' '.join(map(str, p))}\n")  # ä¿å­˜é¢„æµ‹ç»“æœ

        return stats  # è¿”å›ç»Ÿè®¡ä¿¡æ¯
```

### ä»£ç åˆ†æå’Œæ³¨é‡Šè¯´æ˜ï¼š

1. **ç±»å®šä¹‰**ï¼š`OBBValidator` ç»§æ‰¿è‡ª `DetectionValidator`ï¼Œç”¨äºå¤„ç†å®šå‘è¾¹ç•Œæ¡†çš„éªŒè¯ä»»åŠ¡ã€‚

2. **åˆå§‹åŒ–æ–¹æ³•**ï¼šåœ¨åˆå§‹åŒ–ä¸­ï¼Œè®¾ç½®ä»»åŠ¡ç±»å‹ä¸º `obb`ï¼Œå¹¶åˆå§‹åŒ–ç”¨äºè¯„ä¼°çš„æŒ‡æ ‡ `OBBMetrics`ã€‚

3. **åå¤„ç†æ–¹æ³•**ï¼š`postprocess` ä½¿ç”¨éæå¤§å€¼æŠ‘åˆ¶ï¼ˆNMSï¼‰æ¥è¿‡æ»¤æ‰å†—ä½™çš„æ£€æµ‹ç»“æœï¼Œç¡®ä¿æ¯ä¸ªæ£€æµ‹æ¡†çš„å”¯ä¸€æ€§ã€‚

4. **æ‰¹å¤„ç†æ–¹æ³•**ï¼š`_process_batch` è®¡ç®—é¢„æµ‹æ¡†ä¸çœŸå®æ¡†ä¹‹é—´çš„IoUï¼Œå¹¶è¿”å›åŒ¹é…çš„é¢„æµ‹ç»“æœã€‚

5. **ç»˜å›¾æ–¹æ³•**ï¼š`plot_predictions` ç”¨äºåœ¨è¾“å…¥å›¾åƒä¸Šç»˜åˆ¶é¢„æµ‹çš„è¾¹ç•Œæ¡†ï¼Œå¹¶å°†ç»“æœä¿å­˜ä¸ºå›¾åƒæ–‡ä»¶ã€‚

6. **è¯„ä¼°æ–¹æ³•**ï¼š`eval_json` è´Ÿè´£å°†é¢„æµ‹ç»“æœä¿å­˜ä¸ºJSONæ ¼å¼ï¼Œå¹¶æ ¹æ®éœ€è¦å°†ç»“æœè¾“å‡ºä¸ºæ–‡æœ¬æ–‡ä»¶ã€‚

è¿™äº›æ ¸å¿ƒéƒ¨åˆ†æ„æˆäº†OBBValidatorçš„ä¸»è¦åŠŸèƒ½ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°å¤„ç†å®šå‘è¾¹ç•Œæ¡†çš„éªŒè¯å’Œè¯„ä¼°ä»»åŠ¡ã€‚

è¯¥æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªåä¸º `OBBValidator` çš„ç±»ï¼Œç»§æ‰¿è‡ª `DetectionValidator`ï¼Œç”¨äºåŸºäºå®šå‘è¾¹ç•Œæ¡†ï¼ˆOriented Bounding Box, OBBï¼‰æ¨¡å‹çš„éªŒè¯ã€‚è¯¥ç±»ä¸»è¦ç”¨äºå¤„ç†å’Œè¯„ä¼°ç›®æ ‡æ£€æµ‹æ¨¡å‹çš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å…·æœ‰æ—‹è½¬è¾¹ç•Œæ¡†çš„ç›®æ ‡æ—¶ã€‚

åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼Œ`OBBValidator` è®¾ç½®äº†ä»»åŠ¡ç±»å‹ä¸º "obb"ï¼Œå¹¶åˆå§‹åŒ–äº†è¯„ä¼°æŒ‡æ ‡ `OBBMetrics`ï¼Œè¯¥æŒ‡æ ‡ç”¨äºè®¡ç®—æ¨¡å‹åœ¨éªŒè¯é›†ä¸Šçš„æ€§èƒ½ã€‚åˆå§‹åŒ–æ—¶è¿˜æ¥å—äº†ä¸€äº›å‚æ•°ï¼Œå¦‚æ•°æ®åŠ è½½å™¨ã€ä¿å­˜ç›®å½•ã€è¿›åº¦æ¡ã€å…¶ä»–å‚æ•°å’Œå›è°ƒå‡½æ•°ã€‚

`init_metrics` æ–¹æ³•ç”¨äºåˆå§‹åŒ–è¯„ä¼°æŒ‡æ ‡ï¼Œè·å–éªŒè¯æ•°æ®çš„è·¯å¾„ï¼Œå¹¶åˆ¤æ–­æ•°æ®é›†æ˜¯å¦ä¸º DOTA æ ¼å¼ã€‚DOTA æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„ç›®æ ‡æ£€æµ‹æ•°æ®é›†ï¼Œç‰¹åˆ«é€‚ç”¨äºæ—‹è½¬è¾¹ç•Œæ¡†çš„ä»»åŠ¡ã€‚

`postprocess` æ–¹æ³•åº”ç”¨éæå¤§å€¼æŠ‘åˆ¶ï¼ˆNon-Maximum Suppression, NMSï¼‰æ¥å¤„ç†æ¨¡å‹çš„é¢„æµ‹è¾“å‡ºï¼Œä»¥å‡å°‘å†—ä½™çš„æ£€æµ‹ç»“æœã€‚è¿™ä¸ªè¿‡ç¨‹é€šè¿‡è°ƒç”¨ `ops.non_max_suppression` å‡½æ•°å®ç°ï¼Œå…è®¸ç”¨æˆ·è®¾ç½®ç½®ä¿¡åº¦é˜ˆå€¼ã€IoU é˜ˆå€¼ç­‰å‚æ•°ã€‚

`_process_batch` æ–¹æ³•å¤„ç†ä¸€æ‰¹æ£€æµ‹ç»“æœï¼Œè®¡ç®—æ¯ä¸ªæ£€æµ‹ä¸çœŸå®è¾¹ç•Œæ¡†ä¹‹é—´çš„äº¤å¹¶æ¯”ï¼ˆIoUï¼‰ï¼Œå¹¶è¿”å›æ­£ç¡®çš„é¢„æµ‹çŸ©é˜µã€‚è¯¥æ–¹æ³•æ¥å—æ£€æµ‹ç»“æœå’ŒçœŸå®æ ‡ç­¾ä½œä¸ºè¾“å…¥ï¼Œè¾“å‡ºä¸€ä¸ªåŒ…å« IoU çº§åˆ«çš„çŸ©é˜µã€‚

`_prepare_batch` æ–¹æ³•å‡†å¤‡å¹¶è¿”å›ä¸€æ‰¹ç”¨äº OBB éªŒè¯çš„æ•°æ®ï¼ŒåŒ…æ‹¬ç±»åˆ«ã€è¾¹ç•Œæ¡†ã€åŸå§‹å›¾åƒå½¢çŠ¶ç­‰ä¿¡æ¯ã€‚è¯¥æ–¹æ³•è¿˜ä¼šæ ¹æ®å›¾åƒçš„å°ºå¯¸å’Œå¡«å……æ¯”ä¾‹å¯¹è¾¹ç•Œæ¡†è¿›è¡Œç¼©æ”¾ã€‚

`_prepare_pred` æ–¹æ³•å¯¹é¢„æµ‹ç»“æœè¿›è¡Œå¤„ç†ï¼Œè°ƒæ•´è¾¹ç•Œæ¡†çš„å¤§å°å’Œä½ç½®ï¼Œä»¥é€‚åº”åŸå§‹å›¾åƒçš„å°ºå¯¸ã€‚

`plot_predictions` æ–¹æ³•ç”¨äºåœ¨è¾“å…¥å›¾åƒä¸Šç»˜åˆ¶é¢„æµ‹çš„è¾¹ç•Œæ¡†ï¼Œå¹¶å°†ç»“æœä¿å­˜ä¸ºå›¾åƒæ–‡ä»¶ã€‚å®ƒè°ƒç”¨ `plot_images` å‡½æ•°ï¼Œå°†é¢„æµ‹ç»“æœå¯è§†åŒ–ã€‚

`pred_to_json` æ–¹æ³•å°† YOLO çš„é¢„æµ‹ç»“æœåºåˆ—åŒ–ä¸º COCO JSON æ ¼å¼ï¼Œä¾¿äºåç»­çš„åˆ†æå’Œè¯„ä¼°ã€‚å®ƒä¼šæå–æ¯ä¸ªé¢„æµ‹çš„å›¾åƒ IDã€ç±»åˆ« IDã€ç½®ä¿¡åº¦ã€æ—‹è½¬è¾¹ç•Œæ¡†å’Œå¤šè¾¹å½¢åæ ‡ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªå­—å…¸ä¸­ã€‚

`save_one_txt` æ–¹æ³•å°† YOLO çš„æ£€æµ‹ç»“æœä¿å­˜åˆ°ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œé‡‡ç”¨è§„èŒƒåŒ–åæ ‡æ ¼å¼ã€‚è¯¥æ–¹æ³•æ ¹æ®è¾“å…¥çš„å½¢çŠ¶è¿›è¡Œåæ ‡å½’ä¸€åŒ–ï¼Œå¹¶å°†ç»“æœå†™å…¥æŒ‡å®šçš„æ–‡ä»¶ã€‚

`eval_json` æ–¹æ³•è¯„ä¼° YOLO è¾“å‡ºçš„ JSON æ ¼å¼ç»“æœï¼Œå¹¶è¿”å›æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯ã€‚å¦‚æœè®¾ç½®äº†ä¿å­˜ JSON çš„å‚æ•°ï¼Œå¹¶ä¸”æ•°æ®é›†ä¸º DOTA æ ¼å¼ï¼Œå®ƒä¼šå°†é¢„æµ‹ç»“æœä¿å­˜åˆ°ç‰¹å®šçš„æ–‡æœ¬æ–‡ä»¶ä¸­ã€‚è¯¥æ–¹æ³•è¿˜ä¼šåˆå¹¶ç»“æœï¼Œä»¥ä¾¿äºåç»­çš„åˆ†æï¼Œå¹¶ä½¿ç”¨ NMS æ¥å‡å°‘å†—ä½™çš„æ£€æµ‹ç»“æœã€‚

æ€»çš„æ¥è¯´ï¼Œ`OBBValidator` ç±»ä¸ºåŸºäºæ—‹è½¬è¾¹ç•Œæ¡†çš„ç›®æ ‡æ£€æµ‹æ¨¡å‹æä¾›äº†å…¨é¢çš„éªŒè¯å’Œè¯„ä¼°åŠŸèƒ½ï¼Œæ¶µç›–äº†ä»æ•°æ®å‡†å¤‡ã€é¢„æµ‹å¤„ç†åˆ°ç»“æœä¿å­˜å’Œå¯è§†åŒ–çš„å„ä¸ªæ–¹é¢ã€‚

#### 11.2 ui.py

```python
import sys
import subprocess

def run_script(script_path):
    """
    ä½¿ç”¨å½“å‰ Python ç¯å¢ƒè¿è¡ŒæŒ‡å®šçš„è„šæœ¬ã€‚

    Args:
        script_path (str): è¦è¿è¡Œçš„è„šæœ¬è·¯å¾„

    Returns:
        None
    """
    # è·å–å½“å‰ Python è§£é‡Šå™¨çš„è·¯å¾„
    python_path = sys.executable

    # æ„å»ºè¿è¡Œå‘½ä»¤
    command = f'"{python_path}" -m streamlit run "{script_path}"'

    # æ‰§è¡Œå‘½ä»¤
    result = subprocess.run(command, shell=True)
    if result.returncode != 0:
        print("è„šæœ¬è¿è¡Œå‡ºé”™ã€‚")


# å®ä¾‹åŒ–å¹¶è¿è¡Œåº”ç”¨
if __name__ == "__main__":
    # æŒ‡å®šæ‚¨çš„è„šæœ¬è·¯å¾„
    script_path = "web.py"  # è¿™é‡Œå¯ä»¥ç›´æ¥æŒ‡å®šè„šæœ¬åç§°

    # è¿è¡Œè„šæœ¬
    run_script(script_path)
```

### ä»£ç æ³¨é‡Š

1. **å¯¼å…¥æ¨¡å—**ï¼š
   - `import sys`ï¼šå¯¼å…¥ sys æ¨¡å—ä»¥è®¿é—®ä¸ Python è§£é‡Šå™¨å’Œç¯å¢ƒç›¸å…³çš„åŠŸèƒ½ã€‚
   - `import subprocess`ï¼šå¯¼å…¥ subprocess æ¨¡å—ä»¥ä¾¿åœ¨ Python ä¸­æ‰§è¡Œå¤–éƒ¨å‘½ä»¤ã€‚

2. **å®šä¹‰å‡½æ•° `run_script`**ï¼š
   - `def run_script(script_path):`ï¼šå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªå‚æ•° `script_path`ï¼Œè¡¨ç¤ºè¦è¿è¡Œçš„è„šæœ¬çš„è·¯å¾„ã€‚

3. **è·å– Python è§£é‡Šå™¨è·¯å¾„**ï¼š
   - `python_path = sys.executable`ï¼šä½¿ç”¨ `sys.executable` è·å–å½“å‰ Python è§£é‡Šå™¨çš„å®Œæ•´è·¯å¾„ã€‚

4. **æ„å»ºå‘½ä»¤**ï¼š
   - `command = f'"{python_path}" -m streamlit run "{script_path}"'`ï¼šæ„å»ºä¸€ä¸ªå­—ç¬¦ä¸²å‘½ä»¤ï¼Œç”¨äºåœ¨å‘½ä»¤è¡Œä¸­è¿è¡ŒæŒ‡å®šçš„è„šæœ¬ã€‚è¿™é‡Œä½¿ç”¨äº† `streamlit` æ¨¡å—æ¥è¿è¡Œè„šæœ¬ã€‚

5. **æ‰§è¡Œå‘½ä»¤**ï¼š
   - `result = subprocess.run(command, shell=True)`ï¼šä½¿ç”¨ `subprocess.run` æ‰§è¡Œæ„å»ºçš„å‘½ä»¤ã€‚`shell=True` è¡¨ç¤ºåœ¨ shell ä¸­æ‰§è¡Œå‘½ä»¤ã€‚

6. **æ£€æŸ¥å‘½ä»¤æ‰§è¡Œç»“æœ**ï¼š
   - `if result.returncode != 0:`ï¼šæ£€æŸ¥å‘½ä»¤çš„è¿”å›ç ï¼Œå¦‚æœä¸ä¸º 0ï¼Œè¡¨ç¤ºè„šæœ¬è¿è¡Œå‡ºé”™ã€‚
   - `print("è„šæœ¬è¿è¡Œå‡ºé”™ã€‚")`ï¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚

7. **ä¸»ç¨‹åºå…¥å£**ï¼š
   - `if __name__ == "__main__":`ï¼šç¡®ä¿åªæœ‰åœ¨ç›´æ¥è¿è¡Œè¯¥è„šæœ¬æ—¶æ‰ä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç ã€‚
   - `script_path = "web.py"`ï¼šæŒ‡å®šè¦è¿è¡Œçš„è„šæœ¬åç§°ã€‚
   - `run_script(script_path)`ï¼šè°ƒç”¨ `run_script` å‡½æ•°æ¥è¿è¡ŒæŒ‡å®šçš„è„šæœ¬ã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶åä¸º `ui.py`ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯ä½¿ç”¨å½“å‰çš„ Python ç¯å¢ƒæ¥è¿è¡Œä¸€ä¸ªæŒ‡å®šçš„è„šæœ¬ï¼Œå…·ä½“æ˜¯ä¸€ä¸ªåä¸º `web.py` çš„æ–‡ä»¶ã€‚ç¨‹åºé¦–å…ˆå¯¼å…¥äº†å¿…è¦çš„æ¨¡å—ï¼ŒåŒ…æ‹¬ `sys`ã€`os` å’Œ `subprocess`ï¼Œä»¥åŠä¸€ä¸ªè‡ªå®šä¹‰çš„ `abs_path` å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯èƒ½ç”¨äºè·å–æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚

åœ¨ `run_script` å‡½æ•°ä¸­ï¼Œé¦–å…ˆè·å–å½“å‰ Python è§£é‡Šå™¨çš„è·¯å¾„ï¼Œè¿™é€šè¿‡ `sys.executable` å®ç°ã€‚æ¥ç€ï¼Œæ„å»ºä¸€ä¸ªå‘½ä»¤å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªå‘½ä»¤ä½¿ç”¨äº† `streamlit` æ¥è¿è¡ŒæŒ‡å®šçš„è„šæœ¬ã€‚`streamlit` æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæ•°æ®åº”ç”¨çš„æ¡†æ¶ï¼Œå› æ­¤è¿™ä¸ªè„šæœ¬çš„ç›®çš„å¯èƒ½æ˜¯å¯åŠ¨ä¸€ä¸ªåŸºäº Streamlit çš„ web åº”ç”¨ã€‚

ç„¶åï¼Œä½¿ç”¨ `subprocess.run` æ¥æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ã€‚`shell=True` å‚æ•°å…è®¸åœ¨ shell ä¸­æ‰§è¡Œå‘½ä»¤ã€‚æ‰§è¡Œåï¼Œç¨‹åºä¼šæ£€æŸ¥è¿”å›çš„çŠ¶æ€ç ï¼Œå¦‚æœè¿”å›ç ä¸ä¸ºé›¶ï¼Œè¡¨ç¤ºè„šæœ¬è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°äº†é”™è¯¯ï¼Œæ­¤æ—¶ä¼šæ‰“å°å‡ºâ€œè„šæœ¬è¿è¡Œå‡ºé”™ã€‚â€çš„æç¤ºä¿¡æ¯ã€‚

åœ¨æ–‡ä»¶çš„æœ€åéƒ¨åˆ†ï¼Œä½¿ç”¨ `if __name__ == "__main__":` è¯­å¥æ¥ç¡®ä¿åªæœ‰åœ¨ç›´æ¥è¿è¡Œè¯¥è„šæœ¬æ—¶æ‰ä¼šæ‰§è¡Œåé¢çš„ä»£ç ã€‚åœ¨è¿™é‡Œï¼Œé¦–å…ˆè°ƒç”¨ `abs_path` å‡½æ•°æ¥è·å– `web.py` çš„ç»å¯¹è·¯å¾„ï¼Œç„¶åè°ƒç”¨ `run_script` å‡½æ•°æ¥è¿è¡Œè¿™ä¸ªè„šæœ¬ã€‚

æ€»ä½“æ¥çœ‹ï¼Œè¿™ä¸ªç¨‹åºçš„ä¸»è¦åŠŸèƒ½æ˜¯å¯åŠ¨ä¸€ä¸ª Streamlit åº”ç”¨ï¼Œæ–¹ä¾¿ç”¨æˆ·åœ¨æœ¬åœ°ç¯å¢ƒä¸­è¿è¡Œå’Œæµ‹è¯•è¯¥åº”ç”¨ã€‚

#### 11.3 code\ultralytics\models\sam\build.py

ä»¥ä¸‹æ˜¯ä»£ç ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶é™„ä¸Šè¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼š

```python
import torch
from ultralytics.utils.downloads import attempt_download_asset
from .modules.decoders import MaskDecoder
from .modules.encoders import ImageEncoderViT, PromptEncoder
from .modules.sam import Sam
from .modules.tiny_encoder import TinyViT
from .modules.transformer import TwoWayTransformer

def _build_sam(
    encoder_embed_dim, encoder_depth, encoder_num_heads, encoder_global_attn_indexes, checkpoint=None, mobile_sam=False
):
    """æ„å»ºæ‰€é€‰çš„SAMæ¨¡å‹æ¶æ„ã€‚"""
    prompt_embed_dim = 256  # æç¤ºåµŒå…¥çš„ç»´åº¦
    image_size = 1024  # è¾“å…¥å›¾åƒçš„å¤§å°
    vit_patch_size = 16  # ViTçš„è¡¥ä¸å¤§å°
    image_embedding_size = image_size // vit_patch_size  # å›¾åƒåµŒå…¥çš„å¤§å°

    # æ ¹æ®æ˜¯å¦ä¸ºç§»åŠ¨ç‰ˆæœ¬é€‰æ‹©ä¸åŒçš„å›¾åƒç¼–ç å™¨
    image_encoder = (
        TinyViT(
            img_size=1024,
            in_chans=3,
            num_classes=1000,
            embed_dims=encoder_embed_dim,
            depths=encoder_depth,
            num_heads=encoder_num_heads,
            window_sizes=[7, 7, 14, 7],
            mlp_ratio=4.0,
            drop_rate=0.0,
            drop_path_rate=0.0,
            use_checkpoint=False,
            mbconv_expand_ratio=4.0,
            local_conv_size=3,
            layer_lr_decay=0.8,
        )
        if mobile_sam
        else ImageEncoderViT(
            depth=encoder_depth,
            embed_dim=encoder_embed_dim,
            img_size=image_size,
            mlp_ratio=4,
            norm_layer=partial(torch.nn.LayerNorm, eps=1e-6),
            num_heads=encoder_num_heads,
            patch_size=vit_patch_size,
            qkv_bias=True,
            use_rel_pos=True,
            global_attn_indexes=encoder_global_attn_indexes,
            window_size=14,
            out_chans=prompt_embed_dim,
        )
    )

    # åˆ›å»ºSAMæ¨¡å‹ï¼ŒåŒ…å«å›¾åƒç¼–ç å™¨ã€æç¤ºç¼–ç å™¨å’Œæ©ç è§£ç å™¨
    sam = Sam(
        image_encoder=image_encoder,
        prompt_encoder=PromptEncoder(
            embed_dim=prompt_embed_dim,
            image_embedding_size=(image_embedding_size, image_embedding_size),
            input_image_size=(image_size, image_size),
            mask_in_chans=16,
        ),
        mask_decoder=MaskDecoder(
            num_multimask_outputs=3,
            transformer=TwoWayTransformer(
                depth=2,
                embedding_dim=prompt_embed_dim,
                mlp_dim=2048,
                num_heads=8,
            ),
            transformer_dim=prompt_embed_dim,
            iou_head_depth=3,
            iou_head_hidden_dim=256,
        ),
        pixel_mean=[123.675, 116.28, 103.53],  # å›¾åƒçš„å‡å€¼
        pixel_std=[58.395, 57.12, 57.375],  # å›¾åƒçš„æ ‡å‡†å·®
    )

    # å¦‚æœæä¾›äº†æ£€æŸ¥ç‚¹ï¼Œåˆ™åŠ è½½æ¨¡å‹æƒé‡
    if checkpoint is not None:
        checkpoint = attempt_download_asset(checkpoint)  # å°è¯•ä¸‹è½½æ£€æŸ¥ç‚¹
        with open(checkpoint, "rb") as f:
            state_dict = torch.load(f)  # åŠ è½½æƒé‡
        sam.load_state_dict(state_dict)  # å°†æƒé‡åŠ è½½åˆ°æ¨¡å‹ä¸­

    sam.eval()  # è®¾ç½®æ¨¡å‹ä¸ºè¯„ä¼°æ¨¡å¼
    return sam  # è¿”å›æ„å»ºçš„SAMæ¨¡å‹

def build_sam(ckpt="sam_b.pt"):
    """æ ¹æ®æŒ‡å®šçš„ckptæ„å»ºSAMæ¨¡å‹ã€‚"""
    model_builder = None
    ckpt = str(ckpt)  # å°†ckptè½¬æ¢ä¸ºå­—ç¬¦ä¸²ä»¥æ”¯æŒPathç±»å‹
    for k in sam_model_map.keys():
        if ckpt.endswith(k):
            model_builder = sam_model_map.get(k)  # è·å–å¯¹åº”çš„æ¨¡å‹æ„å»ºå‡½æ•°

    if not model_builder:
        raise FileNotFoundError(f"{ckpt} ä¸æ˜¯æ”¯æŒçš„SAMæ¨¡å‹ã€‚å¯ç”¨æ¨¡å‹æœ‰: \n {sam_model_map.keys()}")

    return model_builder(ckpt)  # è°ƒç”¨æ¨¡å‹æ„å»ºå‡½æ•°å¹¶è¿”å›æ¨¡å‹
```

### ä»£ç æ ¸å¿ƒéƒ¨åˆ†è¯´æ˜ï¼š
1. **æ¨¡å‹æ„å»ºå‡½æ•°**ï¼š`_build_sam`å‡½æ•°è´Ÿè´£æ„å»ºä¸åŒé…ç½®çš„SAMæ¨¡å‹ï¼ŒåŒ…æ‹¬é€‰æ‹©åˆé€‚çš„å›¾åƒç¼–ç å™¨å’Œè®¾ç½®ç›¸å…³å‚æ•°ã€‚
2. **å›¾åƒç¼–ç å™¨**ï¼šæ ¹æ®æ˜¯å¦ä¸ºç§»åŠ¨ç‰ˆæœ¬ï¼Œé€‰æ‹©ä¸åŒçš„å›¾åƒç¼–ç å™¨ï¼ˆ`TinyViT`æˆ–`ImageEncoderViT`ï¼‰ã€‚
3. **æ¨¡å‹ç»„ä»¶**ï¼šSAMæ¨¡å‹ç”±å›¾åƒç¼–ç å™¨ã€æç¤ºç¼–ç å™¨å’Œæ©ç è§£ç å™¨ç»„æˆï¼Œè´Ÿè´£å¤„ç†è¾“å…¥å›¾åƒå’Œç”Ÿæˆç›¸åº”çš„æ©ç ã€‚
4. **æƒé‡åŠ è½½**ï¼šå¦‚æœæä¾›äº†æ£€æŸ¥ç‚¹ï¼Œæ¨¡å‹ä¼šå°è¯•ä¸‹è½½å¹¶åŠ è½½é¢„è®­ç»ƒçš„æƒé‡ã€‚
5. **è¯„ä¼°æ¨¡å¼**ï¼šæ¨¡å‹æ„å»ºå®Œæˆåï¼Œè®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼ä»¥å‡†å¤‡è¿›è¡Œæ¨ç†ã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶æ˜¯ç”¨äºæ„å»ºå’Œè¿”å›ä¸åŒå°ºå¯¸çš„â€œSegment Anything Modelâ€ï¼ˆSAMï¼‰æ¨¡å‹çš„ã€‚ç¨‹åºé¦–å…ˆå¯¼å…¥äº†ä¸€äº›å¿…è¦çš„åº“å’Œæ¨¡å—ï¼ŒåŒ…æ‹¬PyTorchå’Œä¸€äº›è‡ªå®šä¹‰çš„æ¨¡å—ï¼Œå¦‚è§£ç å™¨ã€ç¼–ç å™¨å’ŒSAMæ¨¡å‹æœ¬èº«ã€‚

æ–‡ä»¶ä¸­å®šä¹‰äº†å¤šä¸ªæ„å»ºå‡½æ•°ï¼Œåˆ†åˆ«ç”¨äºåˆ›å»ºä¸åŒå¤§å°çš„SAMæ¨¡å‹ï¼ŒåŒ…æ‹¬é«˜ï¼ˆhï¼‰ã€å¤§ï¼ˆlï¼‰ã€å°ï¼ˆbï¼‰å’Œç§»åŠ¨ç‰ˆï¼ˆMobile-SAMï¼‰ã€‚æ¯ä¸ªæ„å»ºå‡½æ•°éƒ½è°ƒç”¨äº†ä¸€ä¸ªç§æœ‰çš„ `_build_sam` å‡½æ•°ï¼Œå¹¶ä¼ å…¥ç‰¹å®šçš„å‚æ•°ï¼Œå¦‚ç¼–ç å™¨çš„åµŒå…¥ç»´åº¦ã€æ·±åº¦ã€å¤´æ•°ä»¥åŠå…¨å±€æ³¨æ„åŠ›ç´¢å¼•ç­‰ã€‚è¿™äº›å‚æ•°å†³å®šäº†æ¨¡å‹çš„ç»“æ„å’Œå¤æ‚åº¦ã€‚

`_build_sam` å‡½æ•°æ˜¯æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒè´Ÿè´£å®é™…æ„å»ºSAMæ¨¡å‹ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œé¦–å…ˆå®šä¹‰äº†ä¸€äº›å¸¸é‡ï¼Œæ¯”å¦‚æç¤ºåµŒå…¥ç»´åº¦ã€å›¾åƒå¤§å°å’Œè¡¥ä¸å¤§å°ã€‚æ¥ç€ï¼Œæ ¹æ®æ˜¯å¦æ„å»ºç§»åŠ¨ç‰ˆæ¨¡å‹ï¼Œé€‰æ‹©ä¸åŒçš„å›¾åƒç¼–ç å™¨ã€‚å¯¹äºç§»åŠ¨ç‰ˆï¼Œä½¿ç”¨çš„æ˜¯ `TinyViT` ç¼–ç å™¨ï¼›å¦åˆ™ï¼Œä½¿ç”¨çš„æ˜¯ `ImageEncoderViT` ç¼–ç å™¨ã€‚

åœ¨æ„å»ºSAMæ¨¡å‹æ—¶ï¼Œè¿˜åŒ…æ‹¬äº†æç¤ºç¼–ç å™¨å’Œæ©ç è§£ç å™¨çš„å®šä¹‰ã€‚æç¤ºç¼–ç å™¨è´Ÿè´£å¤„ç†è¾“å…¥çš„æç¤ºä¿¡æ¯ï¼Œè€Œæ©ç è§£ç å™¨åˆ™ç”¨äºç”Ÿæˆå¤šç§æ©ç è¾“å‡ºï¼Œåˆ©ç”¨ä¸€ä¸ªåŒå‘å˜æ¢å™¨æ¥å¤„ç†è¿™äº›ä¿¡æ¯ã€‚

å¦‚æœæä¾›äº†æ£€æŸ¥ç‚¹ï¼ˆcheckpointï¼‰ï¼Œç¨‹åºä¼šå°è¯•ä¸‹è½½å¹¶åŠ è½½é¢„è®­ç»ƒçš„æ¨¡å‹æƒé‡ã€‚æœ€åï¼Œæ¨¡å‹è¢«è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼ï¼Œå¹¶è¿”å›æ„å»ºå¥½çš„æ¨¡å‹ã€‚

åœ¨æ–‡ä»¶çš„æœ€åéƒ¨åˆ†ï¼Œå®šä¹‰äº†ä¸€ä¸ªå­—å…¸ `sam_model_map`ï¼Œå°†æ¨¡å‹åç§°æ˜ å°„åˆ°ç›¸åº”çš„æ„å»ºå‡½æ•°ã€‚`build_sam` å‡½æ•°æ ¹æ®ç»™å®šçš„æ£€æŸ¥ç‚¹åç§°ï¼ŒæŸ¥æ‰¾å¹¶è°ƒç”¨ç›¸åº”çš„æ„å»ºå‡½æ•°ã€‚å¦‚æœæ£€æŸ¥ç‚¹ä¸åœ¨æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨ä¸­ï¼Œç¨‹åºä¼šæŠ›å‡ºä¸€ä¸ªæ–‡ä»¶æœªæ‰¾åˆ°çš„å¼‚å¸¸ã€‚

æ€»ä½“æ¥è¯´ï¼Œè¿™ä¸ªæ–‡ä»¶çš„ä¸»è¦åŠŸèƒ½æ˜¯æä¾›ä¸€ä¸ªçµæ´»çš„æ¥å£ï¼Œç”¨äºæ„å»ºä¸åŒé…ç½®çš„SAMæ¨¡å‹ï¼Œæ–¹ä¾¿åç»­çš„ä½¿ç”¨å’Œè®­ç»ƒã€‚

#### 11.4 code\ultralytics\utils\tal.py

ä»¥ä¸‹æ˜¯ä»£ç ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶é™„ä¸Šè¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼š

```python
import torch
import torch.nn as nn

class TaskAlignedAssigner(nn.Module):
    """
    ä»»åŠ¡å¯¹é½åˆ†é…å™¨ï¼Œç”¨äºç›®æ ‡æ£€æµ‹ã€‚

    è¯¥ç±»æ ¹æ®ä»»åŠ¡å¯¹é½æŒ‡æ ‡å°†çœŸå®ç›®æ ‡ï¼ˆgtï¼‰åˆ†é…ç»™é”šç‚¹ï¼Œè¯¥æŒ‡æ ‡ç»“åˆäº†åˆ†ç±»å’Œå®šä½ä¿¡æ¯ã€‚

    å±æ€§ï¼š
        topk (int): è€ƒè™‘çš„å€™é€‰æ•°é‡ã€‚
        num_classes (int): ç›®æ ‡ç±»åˆ«æ•°é‡ã€‚
        alpha (float): åˆ†ç±»ç»„ä»¶çš„alphaå‚æ•°ã€‚
        beta (float): å®šä½ç»„ä»¶çš„betaå‚æ•°ã€‚
        eps (float): é˜²æ­¢é™¤ä»¥é›¶çš„å°å€¼ã€‚
    """

    def __init__(self, topk=13, num_classes=80, alpha=1.0, beta=6.0, eps=1e-9):
        """åˆå§‹åŒ–ä»»åŠ¡å¯¹é½åˆ†é…å™¨å¯¹è±¡ï¼Œè®¾ç½®å¯è°ƒè¶…å‚æ•°ã€‚"""
        super().__init__()
        self.topk = topk  # è€ƒè™‘çš„å€™é€‰æ•°é‡
        self.num_classes = num_classes  # ç›®æ ‡ç±»åˆ«æ•°é‡
        self.bg_idx = num_classes  # èƒŒæ™¯ç´¢å¼•
        self.alpha = alpha  # åˆ†ç±»ç»„ä»¶çš„alphaå‚æ•°
        self.beta = beta  # å®šä½ç»„ä»¶çš„betaå‚æ•°
        self.eps = eps  # é˜²æ­¢é™¤ä»¥é›¶çš„å°å€¼

    @torch.no_grad()
    def forward(self, pd_scores, pd_bboxes, anc_points, gt_labels, gt_bboxes, mask_gt):
        """
        è®¡ç®—ä»»åŠ¡å¯¹é½åˆ†é…ã€‚

        å‚æ•°ï¼š
            pd_scores (Tensor): é¢„æµ‹åˆ†æ•°ï¼Œå½¢çŠ¶ä¸º(bs, num_total_anchors, num_classes)
            pd_bboxes (Tensor): é¢„æµ‹è¾¹ç•Œæ¡†ï¼Œå½¢çŠ¶ä¸º(bs, num_total_anchors, 4)
            anc_points (Tensor): é”šç‚¹åæ ‡ï¼Œå½¢çŠ¶ä¸º(num_total_anchors, 2)
            gt_labels (Tensor): çœŸå®æ ‡ç­¾ï¼Œå½¢çŠ¶ä¸º(bs, n_max_boxes, 1)
            gt_bboxes (Tensor): çœŸå®è¾¹ç•Œæ¡†ï¼Œå½¢çŠ¶ä¸º(bs, n_max_boxes, 4)
            mask_gt (Tensor): çœŸå®ç›®æ ‡æ©ç ï¼Œå½¢çŠ¶ä¸º(bs, n_max_boxes, 1)

        è¿”å›ï¼š
            target_labels (Tensor): ç›®æ ‡æ ‡ç­¾ï¼Œå½¢çŠ¶ä¸º(bs, num_total_anchors)
            target_bboxes (Tensor): ç›®æ ‡è¾¹ç•Œæ¡†ï¼Œå½¢çŠ¶ä¸º(bs, num_total_anchors, 4)
            target_scores (Tensor): ç›®æ ‡åˆ†æ•°ï¼Œå½¢çŠ¶ä¸º(bs, num_total_anchors, num_classes)
            fg_mask (Tensor): å‰æ™¯æ©ç ï¼Œå½¢çŠ¶ä¸º(bs, num_total_anchors)
            target_gt_idx (Tensor): ç›®æ ‡çœŸå®ç´¢å¼•ï¼Œå½¢çŠ¶ä¸º(bs, num_total_anchors)
        """
        self.bs = pd_scores.size(0)  # æ‰¹æ¬¡å¤§å°
        self.n_max_boxes = gt_bboxes.size(1)  # æœ€å¤§è¾¹ç•Œæ¡†æ•°é‡

        if self.n_max_boxes == 0:  # å¦‚æœæ²¡æœ‰çœŸå®ç›®æ ‡
            device = gt_bboxes.device
            return (
                torch.full_like(pd_scores[..., 0], self.bg_idx).to(device),  # ç›®æ ‡æ ‡ç­¾ä¸ºèƒŒæ™¯
                torch.zeros_like(pd_bboxes).to(device),  # ç›®æ ‡è¾¹ç•Œæ¡†ä¸ºé›¶
                torch.zeros_like(pd_scores).to(device),  # ç›®æ ‡åˆ†æ•°ä¸ºé›¶
                torch.zeros_like(pd_scores[..., 0]).to(device),  # å‰æ™¯æ©ç ä¸ºé›¶
                torch.zeros_like(pd_scores[..., 0]).to(device),  # ç›®æ ‡çœŸå®ç´¢å¼•ä¸ºé›¶
            )

        # è·å–æ­£æ ·æœ¬æ©ç ã€å¯¹é½æŒ‡æ ‡å’Œé‡å åº¦
        mask_pos, align_metric, overlaps = self.get_pos_mask(
            pd_scores, pd_bboxes, gt_labels, gt_bboxes, anc_points, mask_gt
        )

        # é€‰æ‹©é‡å åº¦æœ€é«˜çš„ç›®æ ‡
        target_gt_idx, fg_mask, mask_pos = self.select_highest_overlaps(mask_pos, overlaps, self.n_max_boxes)

        # è·å–åˆ†é…çš„ç›®æ ‡
        target_labels, target_bboxes, target_scores = self.get_targets(gt_labels, gt_bboxes, target_gt_idx, fg_mask)

        # å½’ä¸€åŒ–å¯¹é½æŒ‡æ ‡
        align_metric *= mask_pos
        pos_align_metrics = align_metric.amax(dim=-1, keepdim=True)  # æ­£æ ·æœ¬çš„æœ€å¤§å¯¹é½æŒ‡æ ‡
        pos_overlaps = (overlaps * mask_pos).amax(dim=-1, keepdim=True)  # æ­£æ ·æœ¬çš„æœ€å¤§é‡å åº¦
        norm_align_metric = (align_metric * pos_overlaps / (pos_align_metrics + self.eps)).amax(-2).unsqueeze(-1)
        target_scores = target_scores * norm_align_metric  # æ›´æ–°ç›®æ ‡åˆ†æ•°

        return target_labels, target_bboxes, target_scores, fg_mask.bool(), target_gt_idx

    def get_pos_mask(self, pd_scores, pd_bboxes, gt_labels, gt_bboxes, anc_points, mask_gt):
        """è·å–æ­£æ ·æœ¬æ©ç ã€‚"""
        mask_in_gts = self.select_candidates_in_gts(anc_points, gt_bboxes)  # é€‰æ‹©åœ¨çœŸå®ç›®æ ‡ä¸­çš„å€™é€‰é”šç‚¹
        align_metric, overlaps = self.get_box_metrics(pd_scores, pd_bboxes, gt_labels, gt_bboxes, mask_in_gts * mask_gt)  # è®¡ç®—å¯¹é½æŒ‡æ ‡å’Œé‡å åº¦
        mask_topk = self.select_topk_candidates(align_metric, topk_mask=mask_gt.expand(-1, -1, self.topk).bool())  # é€‰æ‹©top-kå€™é€‰
        mask_pos = mask_topk * mask_in_gts * mask_gt  # åˆå¹¶æ‰€æœ‰æ©ç 

        return mask_pos, align_metric, overlaps

    def get_box_metrics(self, pd_scores, pd_bboxes, gt_labels, gt_bboxes, mask_gt):
        """è®¡ç®—ç»™å®šé¢„æµ‹å’ŒçœŸå®è¾¹ç•Œæ¡†çš„å¯¹é½æŒ‡æ ‡ã€‚"""
        na = pd_bboxes.shape[-2]  # é”šç‚¹æ•°é‡
        mask_gt = mask_gt.bool()  # è½¬æ¢ä¸ºå¸ƒå°”ç±»å‹
        overlaps = torch.zeros([self.bs, self.n_max_boxes, na], dtype=pd_bboxes.dtype, device=pd_bboxes.device)  # åˆå§‹åŒ–é‡å åº¦
        bbox_scores = torch.zeros([self.bs, self.n_max_boxes, na], dtype=pd_scores.dtype, device=pd_scores.device)  # åˆå§‹åŒ–è¾¹ç•Œæ¡†åˆ†æ•°

        ind = torch.zeros([2, self.bs, self.n_max_boxes], dtype=torch.long)  # åˆå§‹åŒ–ç´¢å¼•
        ind[0] = torch.arange(end=self.bs).view(-1, 1).expand(-1, self.n_max_boxes)  # æ‰¹æ¬¡ç´¢å¼•
        ind[1] = gt_labels.squeeze(-1)  # çœŸå®æ ‡ç­¾ç´¢å¼•
        bbox_scores[mask_gt] = pd_scores[ind[0], :, ind[1]][mask_gt]  # è·å–æ¯ä¸ªç½‘æ ¼çš„åˆ†æ•°

        # è®¡ç®—é‡å åº¦
        pd_boxes = pd_bboxes.unsqueeze(1).expand(-1, self.n_max_boxes, -1, -1)[mask_gt]
        gt_boxes = gt_bboxes.unsqueeze(2).expand(-1, -1, na, -1)[mask_gt]
        overlaps[mask_gt] = self.iou_calculation(gt_boxes, pd_boxes)  # è®¡ç®—IoU

        align_metric = bbox_scores.pow(self.alpha) * overlaps.pow(self.beta)  # è®¡ç®—å¯¹é½æŒ‡æ ‡
        return align_metric, overlaps

    def iou_calculation(self, gt_bboxes, pd_bboxes):
        """è®¡ç®—æ°´å¹³è¾¹ç•Œæ¡†çš„IoUã€‚"""
        return bbox_iou(gt_bboxes, pd_bboxes, xywh=False, CIoU=True).squeeze(-1).clamp_(0)  # è®¡ç®—IoUå¹¶é™åˆ¶åœ¨0ä»¥ä¸Š

    def select_topk_candidates(self, metrics, largest=True, topk_mask=None):
        """æ ¹æ®ç»™å®šæŒ‡æ ‡é€‰æ‹©top-kå€™é€‰ã€‚"""
        topk_metrics, topk_idxs = torch.topk(metrics, self.topk, dim=-1, largest=largest)  # è·å–top-kæŒ‡æ ‡å’Œç´¢å¼•
        if topk_mask is None:
            topk_mask = (topk_metrics.max(-1, keepdim=True)[0] > self.eps).expand_as(topk_idxs)  # ç”Ÿæˆtop-kæ©ç 
        topk_idxs.masked_fill_(~topk_mask, 0)  # å¡«å……æ— æ•ˆç´¢å¼•

        count_tensor = torch.zeros(metrics.shape, dtype=torch.int8, device=topk_idxs.device)  # åˆå§‹åŒ–è®¡æ•°å¼ é‡
        ones = torch.ones_like(topk_idxs[:, :, :1], dtype=torch.int8, device=topk_idxs.device)  # åˆ›å»ºå…¨1å¼ é‡
        for k in range(self.topk):
            count_tensor.scatter_add_(-1, topk_idxs[:, :, k : k + 1], ones)  # ç»Ÿè®¡æ¯ä¸ªtop-kçš„å‡ºç°æ¬¡æ•°
        count_tensor.masked_fill_(count_tensor > 1, 0)  # è¿‡æ»¤æ— æ•ˆè¾¹ç•Œæ¡†

        return count_tensor.to(metrics.dtype)  # è¿”å›æœ‰æ•ˆçš„top-kå€™é€‰

    def get_targets(self, gt_labels, gt_bboxes, target_gt_idx, fg_mask):
        """è®¡ç®—æ­£æ ·æœ¬çš„ç›®æ ‡æ ‡ç­¾ã€ç›®æ ‡è¾¹ç•Œæ¡†å’Œç›®æ ‡åˆ†æ•°ã€‚"""
        batch_ind = torch.arange(end=self.bs, dtype=torch.int64, device=gt_labels.device)[..., None]  # æ‰¹æ¬¡ç´¢å¼•
        target_gt_idx = target_gt_idx + batch_ind * self.n_max_boxes  # æ›´æ–°ç›®æ ‡çœŸå®ç´¢å¼•
        target_labels = gt_labels.long().flatten()[target_gt_idx]  # è·å–ç›®æ ‡æ ‡ç­¾

        target_bboxes = gt_bboxes.view(-1, gt_bboxes.shape[-1])[target_gt_idx]  # è·å–ç›®æ ‡è¾¹ç•Œæ¡†

        target_labels.clamp_(0)  # é™åˆ¶ç›®æ ‡æ ‡ç­¾åœ¨æœ‰æ•ˆèŒƒå›´å†…

        # åˆ›å»ºç›®æ ‡åˆ†æ•°å¼ é‡
        target_scores = torch.zeros(
            (target_labels.shape[0], target_labels.shape[1], self.num_classes),
            dtype=torch.int64,
            device=target_labels.device,
        )  # åˆå§‹åŒ–ç›®æ ‡åˆ†æ•°
        target_scores.scatter_(2, target_labels.unsqueeze(-1), 1)  # å¡«å……ç›®æ ‡åˆ†æ•°

        fg_scores_mask = fg_mask[:, :, None].repeat(1, 1, self.num_classes)  # åˆ›å»ºå‰æ™¯åˆ†æ•°æ©ç 
        target_scores = torch.where(fg_scores_mask > 0, target_scores, 0)  # æ›´æ–°ç›®æ ‡åˆ†æ•°

        return target_labels, target_bboxes, target_scores  # è¿”å›ç›®æ ‡æ ‡ç­¾ã€è¾¹ç•Œæ¡†å’Œåˆ†æ•°

    @staticmethod
    def select_candidates_in_gts(xy_centers, gt_bboxes, eps=1e-9):
        """é€‰æ‹©åœ¨çœŸå®ç›®æ ‡ä¸­çš„æ­£æ ·æœ¬é”šç‚¹ã€‚"""
        n_anchors = xy_centers.shape[0]  # é”šç‚¹æ•°é‡
        bs, n_boxes, _ = gt_bboxes.shape  # æ‰¹æ¬¡å¤§å°å’Œè¾¹ç•Œæ¡†æ•°é‡
        lt, rb = gt_bboxes.view(-1, 1, 4).chunk(2, 2)  # è·å–å·¦ä¸Šè§’å’Œå³ä¸‹è§’åæ ‡
        bbox_deltas = torch.cat((xy_centers[None] - lt, rb - xy_centers[None]), dim=2).view(bs, n_boxes, n_anchors, -1)  # è®¡ç®—è¾¹ç•Œæ¡†åå·®
        return bbox_deltas.amin(3).gt_(eps)  # è¿”å›åœ¨çœŸå®ç›®æ ‡å†…çš„é”šç‚¹

    @staticmethod
    def select_highest_overlaps(mask_pos, overlaps, n_max_boxes):
        """é€‰æ‹©é‡å åº¦æœ€é«˜çš„ç›®æ ‡ã€‚"""
        fg_mask = mask_pos.sum(-2)  # è®¡ç®—å‰æ™¯æ©ç 
        if fg_mask.max() > 1:  # å¦‚æœä¸€ä¸ªé”šç‚¹åˆ†é…ç»™å¤šä¸ªçœŸå®ç›®æ ‡
            mask_multi_gts = (fg_mask.unsqueeze(1) > 1).expand(-1, n_max_boxes, -1)  # åˆ›å»ºå¤šç›®æ ‡æ©ç 
            max_overlaps_idx = overlaps.argmax(1)  # è·å–æœ€å¤§é‡å åº¦ç´¢å¼•

            is_max_overlaps = torch.zeros(mask_pos.shape, dtype=mask_pos.dtype, device=mask_pos.device)  # åˆå§‹åŒ–æœ€å¤§é‡å åº¦æ©ç 
            is_max_overlaps.scatter_(1, max_overlaps_idx.unsqueeze(1), 1)  # å¡«å……æœ€å¤§é‡å åº¦

            mask_pos = torch.where(mask_multi_gts, is_max_overlaps, mask_pos).float()  # æ›´æ–°æ©ç 
            fg_mask = mask_pos.sum(-2)  # æ›´æ–°å‰æ™¯æ©ç 
        target_gt_idx = mask_pos.argmax(-2)  # æ‰¾åˆ°æ¯ä¸ªç½‘æ ¼å¯¹åº”çš„çœŸå®ç›®æ ‡ç´¢å¼•
        return target_gt_idx, fg_mask, mask_pos  # è¿”å›ç›®æ ‡ç´¢å¼•ã€å‰æ™¯æ©ç å’Œæ©ç 
```

### ä»£ç è¯´æ˜
1. **TaskAlignedAssigner ç±»**ï¼šè¿™æ˜¯ä¸€ä¸ªç”¨äºç›®æ ‡æ£€æµ‹çš„ä»»åŠ¡å¯¹é½åˆ†é…å™¨ï¼Œè´Ÿè´£å°†çœŸå®ç›®æ ‡ä¸é”šç‚¹è¿›è¡ŒåŒ¹é…ã€‚
2. **åˆå§‹åŒ–æ–¹æ³•**ï¼šè®¾ç½®äº†ä¸€äº›è¶…å‚æ•°ï¼Œå¦‚è€ƒè™‘çš„å€™é€‰æ•°é‡ã€ç±»åˆ«æ•°é‡ç­‰ã€‚
3. **å‰å‘ä¼ æ’­æ–¹æ³•**ï¼šè®¡ç®—ä»»åŠ¡å¯¹é½åˆ†é…çš„ä¸»è¦é€»è¾‘ï¼ŒåŒ…æ‹¬è·å–æ­£æ ·æœ¬æ©ç ã€é€‰æ‹©é‡å åº¦æœ€é«˜çš„ç›®æ ‡ç­‰ã€‚
4. **è¾…åŠ©æ–¹æ³•**ï¼šåŒ…æ‹¬è®¡ç®—å¯¹é½æŒ‡æ ‡ã€é€‰æ‹©å€™é€‰é”šç‚¹ã€è·å–ç›®æ ‡æ ‡ç­¾å’Œè¾¹ç•Œæ¡†ç­‰åŠŸèƒ½ã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªç”¨äºç›®æ ‡æ£€æµ‹çš„ä»»åŠ¡å¯¹é½åˆ†é…å™¨ï¼ˆTaskAlignedAssignerï¼‰ï¼Œå®ƒé€šè¿‡ç»“åˆåˆ†ç±»å’Œå®šä½ä¿¡æ¯æ¥å°†çœŸå®ç›®æ ‡ï¼ˆground-truthï¼‰åˆ†é…ç»™é”šæ¡†ï¼ˆanchorsï¼‰ã€‚æ–‡ä»¶ä¸­åŒ…å«äº†å¤šä¸ªç±»å’Œå‡½æ•°ï¼Œä¸»è¦åŠŸèƒ½æ˜¯è®¡ç®—é”šæ¡†ä¸çœŸå®ç›®æ ‡ä¹‹é—´çš„åŒ¹é…å…³ç³»ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„ç›®æ ‡æ ‡ç­¾ã€è¾¹ç•Œæ¡†å’Œå¾—åˆ†ã€‚

é¦–å…ˆï¼Œ`TaskAlignedAssigner`ç±»çš„æ„é€ å‡½æ•°åˆå§‹åŒ–äº†ä¸€äº›è¶…å‚æ•°ï¼ŒåŒ…æ‹¬è€ƒè™‘çš„å€™é€‰æ¡†æ•°é‡ï¼ˆtopkï¼‰ã€ç±»åˆ«æ•°é‡ï¼ˆnum_classesï¼‰ã€åˆ†ç±»å’Œå®šä½çš„æƒé‡å‚æ•°ï¼ˆalphaå’Œbetaï¼‰ï¼Œä»¥åŠä¸€ä¸ªå°çš„é˜²æ­¢é™¤é›¶çš„å€¼ï¼ˆepsï¼‰ã€‚è¯¥ç±»çš„`forward`æ–¹æ³•æ¥æ”¶é¢„æµ‹çš„å¾—åˆ†ã€è¾¹ç•Œæ¡†ã€é”šç‚¹ã€çœŸå®æ ‡ç­¾å’Œè¾¹ç•Œæ¡†ç­‰ä¿¡æ¯ï¼Œå¹¶è®¡ç®—ä»»åŠ¡å¯¹é½çš„åˆ†é…ã€‚

åœ¨`forward`æ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰çœŸå®ç›®æ ‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿”å›èƒŒæ™¯ç´¢å¼•å’Œé›¶å€¼çš„è¾¹ç•Œæ¡†å’Œå¾—åˆ†ã€‚æ¥ç€ï¼Œé€šè¿‡è°ƒç”¨`get_pos_mask`æ–¹æ³•è·å–æ­£æ ·æœ¬çš„æ©ç ã€å¯¹é½åº¦é‡å’Œé‡å åº¦é‡ã€‚ç„¶åï¼Œåˆ©ç”¨`select_highest_overlaps`æ–¹æ³•é€‰æ‹©é‡å åº¦é‡æœ€é«˜çš„é”šæ¡†ï¼Œå¹¶é€šè¿‡`get_targets`æ–¹æ³•è·å–ç›®æ ‡æ ‡ç­¾ã€è¾¹ç•Œæ¡†å’Œå¾—åˆ†ã€‚

`get_pos_mask`æ–¹æ³•ç”¨äºè·å–åœ¨çœŸå®ç›®æ ‡ä¸­çš„é”šæ¡†æ©ç ï¼Œè®¡ç®—å¯¹é½åº¦é‡å’Œé‡å åº¦é‡ã€‚`get_box_metrics`æ–¹æ³•åˆ™è®¡ç®—é¢„æµ‹è¾¹ç•Œæ¡†å’ŒçœŸå®è¾¹ç•Œæ¡†ä¹‹é—´çš„å¯¹é½åº¦é‡ï¼Œä½¿ç”¨`iou_calculation`æ–¹æ³•è®¡ç®—äº¤å¹¶æ¯”ï¼ˆIoUï¼‰ã€‚`select_topk_candidates`æ–¹æ³•é€‰æ‹©åŸºäºåº¦é‡çš„å‰kä¸ªå€™é€‰æ¡†ã€‚

`get_targets`æ–¹æ³•ç”Ÿæˆç›®æ ‡æ ‡ç­¾ã€è¾¹ç•Œæ¡†å’Œå¾—åˆ†ï¼Œç¡®ä¿å®ƒä»¬ä¸æ­£æ ·æœ¬çš„æ©ç ç›¸å¯¹åº”ã€‚`select_candidates_in_gts`å’Œ`select_highest_overlaps`æ–¹æ³•ç”¨äºé€‰æ‹©æ­£æ ·æœ¬çš„é”šæ¡†ï¼Œå¹¶å¤„ç†é”šæ¡†ä¸å¤šä¸ªçœŸå®ç›®æ ‡çš„é‡å æƒ…å†µã€‚

æ­¤å¤–ï¼Œæ–‡ä»¶è¿˜å®šä¹‰äº†ä¸€ä¸ª`RotatedTaskAlignedAssigner`ç±»ï¼Œç»§æ‰¿è‡ª`TaskAlignedAssigner`ï¼Œç”¨äºå¤„ç†æ—‹è½¬è¾¹ç•Œæ¡†çš„æƒ…å†µï¼Œé‡å†™äº†IoUè®¡ç®—å’Œå€™é€‰æ¡†é€‰æ‹©çš„æ–¹æ³•ã€‚

æœ€åï¼Œæ–‡ä»¶ä¸­è¿˜åŒ…å«äº†ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œå¦‚`make_anchors`ç”¨äºç”Ÿæˆé”šæ¡†ï¼Œ`dist2bbox`å’Œ`bbox2dist`ç”¨äºåœ¨è¾¹ç•Œæ¡†å’Œè·ç¦»è¡¨ç¤ºä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œ`dist2rbox`ç”¨äºè§£ç é¢„æµ‹çš„æ—‹è½¬è¾¹ç•Œæ¡†åæ ‡ã€‚

æ•´ä½“è€Œè¨€ï¼Œè¿™ä¸ªæ–‡ä»¶å®ç°äº†ä¸€ä¸ªå¤æ‚çš„ç›®æ ‡æ£€æµ‹åˆ†é…æœºåˆ¶ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°å°†é¢„æµ‹ç»“æœä¸çœŸå®ç›®æ ‡è¿›è¡ŒåŒ¹é…ï¼Œå¹¶ä¸ºåç»­çš„è®­ç»ƒå’Œæ¨ç†æä¾›å¿…è¦çš„æ ‡ç­¾å’Œè¾¹ç•Œæ¡†ä¿¡æ¯ã€‚

#### 11.5 train.py

ä»¥ä¸‹æ˜¯ä»£ç ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶é™„ä¸Šè¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼š

```python
class DetectionTrainer(BaseTrainer):
    """
    DetectionTrainerç±»æ‰©å±•äº†BaseTrainerç±»ï¼Œç”¨äºåŸºäºæ£€æµ‹æ¨¡å‹çš„è®­ç»ƒã€‚
    """

    def build_dataset(self, img_path, mode="train", batch=None):
        """
        æ„å»ºYOLOæ•°æ®é›†ã€‚

        å‚æ•°:
            img_path (str): åŒ…å«å›¾åƒçš„æ–‡ä»¶å¤¹è·¯å¾„ã€‚
            mode (str): æ¨¡å¼ï¼Œ`train`è¡¨ç¤ºè®­ç»ƒæ¨¡å¼ï¼Œ`val`è¡¨ç¤ºéªŒè¯æ¨¡å¼ï¼Œç”¨æˆ·å¯ä»¥ä¸ºæ¯ç§æ¨¡å¼è‡ªå®šä¹‰ä¸åŒçš„å¢å¼ºã€‚
            batch (int, optional): æ‰¹æ¬¡å¤§å°ï¼Œä»…ç”¨äº`rect`æ¨¡å¼ã€‚é»˜è®¤ä¸ºNoneã€‚
        """
        gs = max(int(de_parallel(self.model).stride.max() if self.model else 0), 32)  # è·å–æ¨¡å‹çš„æœ€å¤§æ­¥å¹…
        return build_yolo_dataset(self.args, img_path, batch, self.data, mode=mode, rect=mode == "val", stride=gs)

    def get_dataloader(self, dataset_path, batch_size=16, rank=0, mode="train"):
        """æ„é€ å¹¶è¿”å›æ•°æ®åŠ è½½å™¨ã€‚"""
        assert mode in ["train", "val"]  # ç¡®ä¿æ¨¡å¼æ˜¯è®­ç»ƒæˆ–éªŒè¯
        with torch_distributed_zero_first(rank):  # åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œç¡®ä¿æ•°æ®é›†åªåˆå§‹åŒ–ä¸€æ¬¡
            dataset = self.build_dataset(dataset_path, mode, batch_size)  # æ„å»ºæ•°æ®é›†
        shuffle = mode == "train"  # è®­ç»ƒæ¨¡å¼ä¸‹æ‰“ä¹±æ•°æ®
        if getattr(dataset, "rect", False) and shuffle:
            LOGGER.warning("WARNING âš ï¸ 'rect=True'ä¸DataLoaderçš„shuffleä¸å…¼å®¹ï¼Œè®¾ç½®shuffle=False")
            shuffle = False  # å¦‚æœæ˜¯rectæ¨¡å¼ä¸”éœ€è¦æ‰“ä¹±ï¼Œåˆ™ä¸æ‰“ä¹±
        workers = self.args.workers if mode == "train" else self.args.workers * 2  # è®¾ç½®å·¥ä½œçº¿ç¨‹æ•°
        return build_dataloader(dataset, batch_size, workers, shuffle, rank)  # è¿”å›æ•°æ®åŠ è½½å™¨

    def preprocess_batch(self, batch):
        """å¯¹ä¸€æ‰¹å›¾åƒè¿›è¡Œé¢„å¤„ç†ï¼ŒåŒ…æ‹¬ç¼©æ”¾å’Œè½¬æ¢ä¸ºæµ®ç‚¹æ•°ã€‚"""
        batch["img"] = batch["img"].to(self.device, non_blocking=True).float() / 255  # å°†å›¾åƒè½¬ç§»åˆ°è®¾å¤‡å¹¶å½’ä¸€åŒ–
        if self.args.multi_scale:  # å¦‚æœå¯ç”¨å¤šå°ºåº¦
            imgs = batch["img"]
            sz = (
                random.randrange(self.args.imgsz * 0.5, self.args.imgsz * 1.5 + self.stride)
                // self.stride
                * self.stride
            )  # éšæœºé€‰æ‹©ä¸€ä¸ªæ–°çš„å°ºå¯¸
            sf = sz / max(imgs.shape[2:])  # è®¡ç®—ç¼©æ”¾å› å­
            if sf != 1:
                ns = [
                    math.ceil(x * sf / self.stride) * self.stride for x in imgs.shape[2:]
                ]  # è®¡ç®—æ–°çš„å½¢çŠ¶
                imgs = nn.functional.interpolate(imgs, size=ns, mode="bilinear", align_corners=False)  # è¿›è¡Œæ’å€¼
            batch["img"] = imgs  # æ›´æ–°æ‰¹æ¬¡å›¾åƒ
        return batch

    def get_model(self, cfg=None, weights=None, verbose=True):
        """è¿”å›YOLOæ£€æµ‹æ¨¡å‹ã€‚"""
        model = DetectionModel(cfg, nc=self.data["nc"], verbose=verbose and RANK == -1)  # åˆ›å»ºæ£€æµ‹æ¨¡å‹
        if weights:
            model.load(weights)  # åŠ è½½æƒé‡
        return model

    def get_validator(self):
        """è¿”å›ç”¨äºYOLOæ¨¡å‹éªŒè¯çš„DetectionValidatorã€‚"""
        self.loss_names = "box_loss", "cls_loss", "dfl_loss"  # å®šä¹‰æŸå¤±åç§°
        return yolo.detect.DetectionValidator(
            self.test_loader, save_dir=self.save_dir, args=copy(self.args), _callbacks=self.callbacks
        )  # è¿”å›éªŒè¯å™¨

    def plot_training_samples(self, batch, ni):
        """ç»˜åˆ¶å¸¦æœ‰æ³¨é‡Šçš„è®­ç»ƒæ ·æœ¬ã€‚"""
        plot_images(
            images=batch["img"],
            batch_idx=batch["batch_idx"],
            cls=batch["cls"].squeeze(-1),
            bboxes=batch["bboxes"],
            paths=batch["im_file"],
            fname=self.save_dir / f"train_batch{ni}.jpg",
            on_plot=self.on_plot,
        )
```

### ä»£ç æ ¸å¿ƒéƒ¨åˆ†è¯´æ˜ï¼š
1. **DetectionTrainerç±»**ï¼šè¿™æ˜¯ä¸€ä¸ªç”¨äºè®­ç»ƒYOLOæ£€æµ‹æ¨¡å‹çš„ç±»ï¼Œç»§æ‰¿è‡ªBaseTrainerã€‚
2. **build_datasetæ–¹æ³•**ï¼šç”¨äºæ„å»ºYOLOæ•°æ®é›†ï¼Œæ¥å—å›¾åƒè·¯å¾„ã€æ¨¡å¼å’Œæ‰¹æ¬¡å¤§å°ä½œä¸ºå‚æ•°ã€‚
3. **get_dataloaderæ–¹æ³•**ï¼šæ„é€ æ•°æ®åŠ è½½å™¨ï¼Œæ”¯æŒè®­ç»ƒå’ŒéªŒè¯æ¨¡å¼ï¼Œå¹¶å¤„ç†æ•°æ®çš„æ‰“ä¹±å’Œå·¥ä½œçº¿ç¨‹æ•°ã€‚
4. **preprocess_batchæ–¹æ³•**ï¼šå¯¹è¾“å…¥çš„å›¾åƒæ‰¹æ¬¡è¿›è¡Œé¢„å¤„ç†ï¼ŒåŒ…æ‹¬å½’ä¸€åŒ–å’Œå¤šå°ºåº¦è°ƒæ•´ã€‚
5. **get_modelæ–¹æ³•**ï¼šè¿”å›ä¸€ä¸ªYOLOæ£€æµ‹æ¨¡å‹ï¼Œå¯ä»¥é€‰æ‹©åŠ è½½é¢„è®­ç»ƒæƒé‡ã€‚
6. **get_validatoræ–¹æ³•**ï¼šè¿”å›ä¸€ä¸ªç”¨äºéªŒè¯æ¨¡å‹æ€§èƒ½çš„éªŒè¯å™¨ã€‚
7. **plot_training_samplesæ–¹æ³•**ï¼šç”¨äºç»˜åˆ¶è®­ç»ƒæ ·æœ¬åŠå…¶æ³¨é‡Šï¼Œä¾¿äºå¯è§†åŒ–è®­ç»ƒè¿‡ç¨‹ã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶ `train.py` æ˜¯ä¸€ä¸ªç”¨äºè®­ç»ƒ YOLOï¼ˆYou Only Look Onceï¼‰ç›®æ ‡æ£€æµ‹æ¨¡å‹çš„å®ç°ï¼ŒåŸºäº Ultralytics æä¾›çš„æ¡†æ¶ã€‚æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ªåä¸º `DetectionTrainer` çš„ç±»ï¼Œè¯¥ç±»ç»§æ‰¿è‡ª `BaseTrainer`ï¼Œä¸“é—¨ç”¨äºå¤„ç†ç›®æ ‡æ£€æµ‹ä»»åŠ¡ã€‚

åœ¨è¿™ä¸ªç±»ä¸­ï¼Œé¦–å…ˆå®šä¹‰äº† `build_dataset` æ–¹æ³•ï¼Œç”¨äºæ„å»º YOLO æ•°æ®é›†ã€‚è¯¥æ–¹æ³•æ¥æ”¶å›¾åƒè·¯å¾„ã€æ¨¡å¼ï¼ˆè®­ç»ƒæˆ–éªŒè¯ï¼‰å’Œæ‰¹æ¬¡å¤§å°ä½œä¸ºå‚æ•°ã€‚å®ƒé€šè¿‡è°ƒç”¨ `build_yolo_dataset` å‡½æ•°æ¥ç”Ÿæˆæ•°æ®é›†ï¼Œæ”¯æŒä¸åŒæ¨¡å¼ä¸‹çš„å›¾åƒå¢å¼ºã€‚

æ¥ä¸‹æ¥æ˜¯ `get_dataloader` æ–¹æ³•ï¼Œå®ƒæ„å»ºå¹¶è¿”å›æ•°æ®åŠ è½½å™¨ã€‚æ­¤æ–¹æ³•ä¼šæ ¹æ®æ¨¡å¼ï¼ˆè®­ç»ƒæˆ–éªŒè¯ï¼‰åˆå§‹åŒ–æ•°æ®é›†ï¼Œå¹¶æ ¹æ®éœ€è¦è®¾ç½®æ•°æ®åŠ è½½çš„éšæœºæ€§ã€‚å®ƒè¿˜ä¼šæ ¹æ®æ¨¡å¼é€‰æ‹©å·¥ä½œçº¿ç¨‹çš„æ•°é‡ï¼Œå¹¶è°ƒç”¨ `build_dataloader` å‡½æ•°è¿”å›æœ€ç»ˆçš„æ•°æ®åŠ è½½å™¨ã€‚

`preprocess_batch` æ–¹æ³•ç”¨äºå¯¹ä¸€æ‰¹å›¾åƒè¿›è¡Œé¢„å¤„ç†ï¼ŒåŒ…æ‹¬ç¼©æ”¾å’Œè½¬æ¢ä¸ºæµ®ç‚¹æ•°ã€‚å®ƒä¼šå°†å›¾åƒæ•°æ®å½’ä¸€åŒ–åˆ° [0, 1] çš„èŒƒå›´ï¼Œå¹¶æ ¹æ®è®¾ç½®çš„å¤šå°ºåº¦å‚æ•°éšæœºè°ƒæ•´å›¾åƒçš„å¤§å°ã€‚

`set_model_attributes` æ–¹æ³•ç”¨äºè®¾ç½®æ¨¡å‹çš„å±æ€§ï¼ŒåŒ…æ‹¬ç±»åˆ«æ•°é‡å’Œç±»åˆ«åç§°ç­‰ï¼Œä»¥ç¡®ä¿æ¨¡å‹èƒ½å¤Ÿæ­£ç¡®å¤„ç†æ•°æ®é›†ä¸­çš„æ ‡ç­¾ã€‚

`get_model` æ–¹æ³•è¿”å›ä¸€ä¸ª YOLO æ£€æµ‹æ¨¡å‹å®ä¾‹ï¼Œå¹¶å¯ä»¥åŠ è½½é¢„è®­ç»ƒæƒé‡ã€‚

`get_validator` æ–¹æ³•è¿”å›ä¸€ä¸ªç”¨äºéªŒè¯ YOLO æ¨¡å‹çš„éªŒè¯å™¨ï¼Œè®¾ç½®äº†æŸå¤±åç§°ä»¥ä¾¿åç»­ç›‘æ§è®­ç»ƒè¿‡ç¨‹ä¸­çš„æŸå¤±ã€‚

`label_loss_items` æ–¹æ³•ç”¨äºè¿”å›ä¸€ä¸ªåŒ…å«è®­ç»ƒæŸå¤±é¡¹çš„å­—å…¸ï¼Œä¾¿äºåç»­çš„æŸå¤±ç›‘æ§å’Œè®°å½•ã€‚

`progress_string` æ–¹æ³•è¿”å›ä¸€ä¸ªæ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ï¼Œæ˜¾ç¤ºè®­ç»ƒè¿›åº¦ï¼ŒåŒ…æ‹¬å½“å‰çš„ epochã€GPU å†…å­˜ä½¿ç”¨æƒ…å†µã€æŸå¤±å€¼ã€å®ä¾‹æ•°é‡å’Œå›¾åƒå¤§å°ç­‰ä¿¡æ¯ã€‚

`plot_training_samples` æ–¹æ³•ç”¨äºç»˜åˆ¶è®­ç»ƒæ ·æœ¬åŠå…¶æ ‡æ³¨ï¼Œä¾¿äºå¯è§†åŒ–è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ•°æ®ã€‚

æœ€åï¼Œ`plot_metrics` å’Œ `plot_training_labels` æ–¹æ³•åˆ†åˆ«ç”¨äºç»˜åˆ¶è®­ç»ƒè¿‡ç¨‹ä¸­çš„æŒ‡æ ‡å’Œåˆ›å»ºå¸¦æ ‡ç­¾çš„è®­ç»ƒå›¾ï¼Œå¸®åŠ©ç”¨æˆ·åˆ†ææ¨¡å‹çš„è®­ç»ƒæ•ˆæœã€‚

æ€»ä½“è€Œè¨€ï¼Œè¿™ä¸ªæ–‡ä»¶æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„æ¡†æ¶ï¼Œç”¨äºè®­ç»ƒ YOLO æ¨¡å‹ï¼ŒåŒ…å«æ•°æ®é›†æ„å»ºã€æ•°æ®åŠ è½½ã€æ¨¡å‹è®­ç»ƒã€æŸå¤±ç›‘æ§å’Œç»“æœå¯è§†åŒ–ç­‰åŠŸèƒ½ã€‚

#### 11.6 code\ultralytics\models\yolo\pose\predict.py

ä»¥ä¸‹æ˜¯ä»£ç ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶é™„ä¸Šè¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼š

```python
from ultralytics.engine.results import Results  # å¯¼å…¥ç»“æœå¤„ç†ç±»
from ultralytics.models.yolo.detect.predict import DetectionPredictor  # å¯¼å…¥æ£€æµ‹é¢„æµ‹å™¨åŸºç±»
from ultralytics.utils import DEFAULT_CFG, LOGGER, ops  # å¯¼å…¥é»˜è®¤é…ç½®ã€æ—¥å¿—è®°å½•å™¨å’Œæ“ä½œå·¥å…·

class PosePredictor(DetectionPredictor):
    """
    PosePredictorç±»ï¼Œæ‰©å±•è‡ªDetectionPredictorç±»ï¼Œç”¨äºåŸºäºå§¿æ€æ¨¡å‹çš„é¢„æµ‹ã€‚
    """

    def __init__(self, cfg=DEFAULT_CFG, overrides=None, _callbacks=None):
        """åˆå§‹åŒ–PosePredictorï¼Œè®¾ç½®ä»»åŠ¡ä¸º'pose'å¹¶è®°å½•ä½¿ç”¨'mps'ä½œä¸ºè®¾å¤‡çš„è­¦å‘Šã€‚"""
        super().__init__(cfg, overrides, _callbacks)  # è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°
        self.args.task = "pose"  # è®¾ç½®ä»»åŠ¡ç±»å‹ä¸ºå§¿æ€æ£€æµ‹
        # æ£€æŸ¥è®¾å¤‡ç±»å‹ï¼Œå¦‚æœæ˜¯Apple MPSï¼Œè®°å½•è­¦å‘Šä¿¡æ¯
        if isinstance(self.args.device, str) and self.args.device.lower() == "mps":
            LOGGER.warning(
                "WARNING âš ï¸ Apple MPS known Pose bug. Recommend 'device=cpu' for Pose models. "
                "See https://github.com/ultralytics/ultralytics/issues/4031."
            )

    def postprocess(self, preds, img, orig_imgs):
        """è¿”å›ç»™å®šè¾“å…¥å›¾åƒæˆ–å›¾åƒåˆ—è¡¨çš„æ£€æµ‹ç»“æœã€‚"""
        # åº”ç”¨éæå¤§å€¼æŠ‘åˆ¶ï¼Œè¿‡æ»¤æ£€æµ‹ç»“æœ
        preds = ops.non_max_suppression(
            preds,
            self.args.conf,  # ç½®ä¿¡åº¦é˜ˆå€¼
            self.args.iou,  # IOUé˜ˆå€¼
            agnostic=self.args.agnostic_nms,  # æ˜¯å¦ç±»åˆ«æ— å…³çš„NMS
            max_det=self.args.max_det,  # æœ€å¤§æ£€æµ‹æ•°é‡
            classes=self.args.classes,  # è¿‡æ»¤çš„ç±»åˆ«
            nc=len(self.model.names),  # ç±»åˆ«æ•°é‡
        )

        # å¦‚æœè¾“å…¥å›¾åƒä¸æ˜¯åˆ—è¡¨ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºnumpyæ•°ç»„
        if not isinstance(orig_imgs, list):
            orig_imgs = ops.convert_torch2numpy_batch(orig_imgs)

        results = []  # å­˜å‚¨ç»“æœçš„åˆ—è¡¨
        for i, pred in enumerate(preds):  # éå†æ¯ä¸ªé¢„æµ‹ç»“æœ
            orig_img = orig_imgs[i]  # è·å–åŸå§‹å›¾åƒ
            # å°†é¢„æµ‹æ¡†çš„åæ ‡ç¼©æ”¾åˆ°åŸå§‹å›¾åƒçš„å°ºå¯¸
            pred[:, :4] = ops.scale_boxes(img.shape[2:], pred[:, :4], orig_img.shape).round()
            # è·å–å…³é”®ç‚¹é¢„æµ‹ï¼Œå¹¶æ ¹æ®æ¨¡å‹çš„å…³é”®ç‚¹å½¢çŠ¶è¿›è¡Œè°ƒæ•´
            pred_kpts = pred[:, 6:].view(len(pred), *self.model.kpt_shape) if len(pred) else pred[:, 6:]
            # å°†å…³é”®ç‚¹åæ ‡ç¼©æ”¾åˆ°åŸå§‹å›¾åƒçš„å°ºå¯¸
            pred_kpts = ops.scale_coords(img.shape[2:], pred_kpts, orig_img.shape)
            img_path = self.batch[0][i]  # è·å–å›¾åƒè·¯å¾„
            # å°†ç»“æœå­˜å‚¨åˆ°Resultså¯¹è±¡ä¸­
            results.append(
                Results(orig_img, path=img_path, names=self.model.names, boxes=pred[:, :6], keypoints=pred_kpts)
            )
        return results  # è¿”å›å¤„ç†åçš„ç»“æœ
```

### ä»£ç æ ¸å¿ƒéƒ¨åˆ†è§£é‡Šï¼š
1. **PosePredictorç±»**ï¼šè¯¥ç±»ç»§æ‰¿è‡ª`DetectionPredictor`ï¼Œç”¨äºå§¿æ€æ£€æµ‹ä»»åŠ¡ã€‚
2. **åˆå§‹åŒ–æ–¹æ³•**ï¼šè®¾ç½®ä»»åŠ¡ç±»å‹ä¸ºâ€œposeâ€ï¼Œå¹¶å¯¹ä½¿ç”¨ç‰¹å®šè®¾å¤‡ï¼ˆå¦‚Apple MPSï¼‰å‘å‡ºè­¦å‘Šã€‚
3. **åå¤„ç†æ–¹æ³•**ï¼šå¤„ç†æ¨¡å‹çš„é¢„æµ‹ç»“æœï¼ŒåŒ…æ‹¬åº”ç”¨éæå¤§å€¼æŠ‘åˆ¶ã€åæ ‡ç¼©æ”¾ç­‰ï¼Œæœ€ç»ˆè¿”å›åŒ…å«åŸå§‹å›¾åƒã€è·¯å¾„ã€æ£€æµ‹æ¡†å’Œå…³é”®ç‚¹çš„ç»“æœåˆ—è¡¨ã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªåä¸º `PosePredictor` çš„ç±»ï¼Œå®ƒæ˜¯ä» `DetectionPredictor` ç±»æ‰©å±•è€Œæ¥çš„ï¼Œä¸»è¦ç”¨äºåŸºäºå§¿æ€æ¨¡å‹è¿›è¡Œé¢„æµ‹ã€‚æ–‡ä»¶å¼€å¤´åŒ…å«äº†ç‰ˆæƒä¿¡æ¯å’Œå¿…è¦çš„æ¨¡å—å¯¼å…¥ï¼ŒåŒ…æ‹¬ `Results`ã€`DetectionPredictor` å’Œä¸€äº›å·¥å…·å‡½æ•°ã€‚

åœ¨ `PosePredictor` ç±»çš„æ„é€ å‡½æ•° `__init__` ä¸­ï¼Œé¦–å…ˆè°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œå¹¶å°†ä»»åŠ¡ç±»å‹è®¾ç½®ä¸º "pose"ã€‚å¦‚æœç”¨æˆ·æŒ‡å®šçš„è®¾å¤‡æ˜¯ "mps"ï¼ˆå³è‹¹æœçš„é‡‘å±æ€§èƒ½ç€è‰²å™¨ï¼‰ï¼Œåˆ™ä¼šå‘å‡ºè­¦å‘Šï¼Œæç¤ºç”¨æˆ·ä½¿ç”¨ CPU è¿›è¡Œå§¿æ€æ¨¡å‹çš„æ¨ç†ï¼Œå› ä¸ºåœ¨ MPS ä¸Šå­˜åœ¨å·²çŸ¥çš„ bugã€‚

ç±»ä¸­è¿˜å®šä¹‰äº†ä¸€ä¸ª `postprocess` æ–¹æ³•ï¼Œç”¨äºå¤„ç†æ¨¡å‹çš„é¢„æµ‹ç»“æœã€‚è¯¥æ–¹æ³•æ¥æ”¶é¢„æµ‹ç»“æœã€è¾“å…¥å›¾åƒå’ŒåŸå§‹å›¾åƒä½œä¸ºå‚æ•°ã€‚é¦–å…ˆï¼Œå®ƒè°ƒç”¨ `non_max_suppression` å‡½æ•°å¯¹é¢„æµ‹ç»“æœè¿›è¡Œéæå¤§å€¼æŠ‘åˆ¶ï¼Œä»¥è¿‡æ»¤æ‰é‡å çš„æ£€æµ‹æ¡†ã€‚æ¥ç€ï¼Œæ£€æŸ¥è¾“å…¥çš„åŸå§‹å›¾åƒæ˜¯å¦ä¸ºåˆ—è¡¨ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸º NumPy æ•°ç»„ã€‚

éšåï¼Œæ–¹æ³•éå†æ¯ä¸ªé¢„æµ‹ç»“æœï¼Œè°ƒæ•´æ£€æµ‹æ¡†çš„åæ ‡ï¼Œä½¿å…¶é€‚åº”åŸå§‹å›¾åƒçš„å°ºå¯¸ï¼Œå¹¶å°†å…³é”®ç‚¹çš„åæ ‡è¿›è¡Œç›¸åº”çš„ç¼©æ”¾ã€‚æœ€åï¼Œå°†å¤„ç†åçš„ç»“æœå­˜å‚¨åœ¨ `Results` å¯¹è±¡ä¸­ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°ç»“æœåˆ—è¡¨ä¸­ã€‚æœ€ç»ˆï¼Œæ–¹æ³•è¿”å›è¿™ä¸ªç»“æœåˆ—è¡¨ã€‚

æ•´ä½“æ¥çœ‹ï¼Œè¿™ä¸ªæ–‡ä»¶å®ç°äº†ä¸€ä¸ªç”¨äºå§¿æ€ä¼°è®¡çš„é¢„æµ‹å™¨ï¼Œæä¾›äº†æ¨¡å‹åŠ è½½ã€è®¾å¤‡è®¾ç½®å’Œç»“æœåå¤„ç†ç­‰åŠŸèƒ½ï¼Œä¾¿äºç”¨æˆ·è¿›è¡Œå§¿æ€æ£€æµ‹ä»»åŠ¡ã€‚

### 12.ç³»ç»Ÿæ•´ä½“ç»“æ„ï¼ˆèŠ‚é€‰ï¼‰

### æ•´ä½“åŠŸèƒ½å’Œæ„æ¶æ¦‚æ‹¬

è¯¥é¡¹ç›®ä¸»è¦å›´ç»•ç›®æ ‡æ£€æµ‹å’Œå§¿æ€ä¼°è®¡ä»»åŠ¡ï¼Œä½¿ç”¨ YOLOï¼ˆYou Only Look Onceï¼‰æ¨¡å‹åŠå…¶å˜ä½“è¿›è¡Œè®­ç»ƒå’Œæ¨ç†ã€‚æ•´ä½“æ¶æ„åŒ…æ‹¬æ¨¡å‹æ„å»ºã€æ•°æ®å¤„ç†ã€è®­ç»ƒã€éªŒè¯å’Œé¢„æµ‹ç­‰å¤šä¸ªæ¨¡å—ï¼Œæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„å·¥ä½œæµæ¥æ”¯æŒç›®æ ‡æ£€æµ‹å’Œå§¿æ€ä¼°è®¡çš„åº”ç”¨ã€‚

- **æ¨¡å‹æ„å»º**ï¼šé€šè¿‡ `build.py` æ–‡ä»¶æ„å»ºä¸åŒé…ç½®çš„æ¨¡å‹ï¼Œæ”¯æŒå¤šç§å°ºå¯¸å’Œç±»å‹çš„ YOLO æ¨¡å‹ã€‚
- **æ•°æ®å¤„ç†**ï¼šé€šè¿‡ `train.py` å’Œ `tal.py` æ–‡ä»¶å¤„ç†æ•°æ®é›†ï¼Œæ„å»ºæ•°æ®åŠ è½½å™¨ï¼Œå¹¶è¿›è¡Œæ•°æ®å¢å¼ºå’Œé¢„å¤„ç†ã€‚
- **è®­ç»ƒå’ŒéªŒè¯**ï¼š`train.py` æ–‡ä»¶è´Ÿè´£æ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ï¼Œ`val.py` æ–‡ä»¶ç”¨äºæ¨¡å‹çš„éªŒè¯ï¼Œè¯„ä¼°æ¨¡å‹æ€§èƒ½ã€‚
- **é¢„æµ‹**ï¼š`predict.py` æ–‡ä»¶ç”¨äºæ¨¡å‹çš„æ¨ç†ï¼Œå¤„ç†è¾“å…¥æ•°æ®å¹¶è¿”å›é¢„æµ‹ç»“æœã€‚
- **ç”¨æˆ·ç•Œé¢**ï¼š`ui.py` æ–‡ä»¶æä¾›äº†ä¸€ä¸ªç®€å•çš„ç”¨æˆ·ç•Œé¢ï¼Œç”¨äºå¯åŠ¨å’Œè¿è¡Œæ¨¡å‹ã€‚
- **å…¶ä»–åŠŸèƒ½**ï¼šåŒ…æ‹¬å›è°ƒå‡½æ•°ã€æ³¨æ„åŠ›æœºåˆ¶ç­‰æ¨¡å—ï¼Œå¢å¼ºæ¨¡å‹çš„åŠŸèƒ½å’Œæ€§èƒ½ã€‚

### æ–‡ä»¶åŠŸèƒ½æ•´ç†è¡¨

| æ–‡ä»¶è·¯å¾„                                                              | åŠŸèƒ½æè¿°                                                                                       |
|---------------------------------------------------------------------|-----------------------------------------------------------------------------------------------|
| `code\ultralytics\models\yolo\obb\val.py`                          | å®šä¹‰äº† `OBBValidator` ç±»ï¼Œç”¨äºéªŒè¯åŸºäºæ—‹è½¬è¾¹ç•Œæ¡†çš„ç›®æ ‡æ£€æµ‹æ¨¡å‹ï¼Œè®¡ç®—æ€§èƒ½æŒ‡æ ‡å’Œå¤„ç†é¢„æµ‹ç»“æœã€‚         |
| `ui.py`                                                            | æä¾›ä¸€ä¸ªç”¨æˆ·ç•Œé¢ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å‘½ä»¤è¡Œå¯åŠ¨å¹¶è¿è¡ŒæŒ‡å®šçš„ `web.py` è„šæœ¬ã€‚                             |
| `code\ultralytics\models\sam\build.py`                             | æ„å»ºä¸åŒå°ºå¯¸çš„ Segment Anything Modelï¼ˆSAMï¼‰ï¼Œæä¾›æ¨¡å‹çš„åˆå§‹åŒ–å’Œé¢„è®­ç»ƒæƒé‡åŠ è½½åŠŸèƒ½ã€‚                |
| `code\ultralytics\utils\tal.py`                                   | å®ç°ç›®æ ‡æ£€æµ‹çš„ä»»åŠ¡å¯¹é½åˆ†é…å™¨ï¼Œè®¡ç®—é”šæ¡†ä¸çœŸå®ç›®æ ‡ä¹‹é—´çš„åŒ¹é…å…³ç³»ï¼Œå¹¶ç”Ÿæˆç›®æ ‡æ ‡ç­¾å’Œè¾¹ç•Œæ¡†ã€‚            |
| `train.py`                                                         | è´Ÿè´£è®­ç»ƒ YOLO æ¨¡å‹ï¼Œæ„å»ºæ•°æ®é›†å’Œæ•°æ®åŠ è½½å™¨ï¼Œç›‘æ§è®­ç»ƒè¿‡ç¨‹ä¸­çš„æŸå¤±å’ŒæŒ‡æ ‡ï¼Œæ”¯æŒå¯è§†åŒ–ã€‚                |
| `code\ultralytics\models\yolo\pose\predict.py`                   | å®šä¹‰ `PosePredictor` ç±»ï¼Œç”¨äºå§¿æ€ä¼°è®¡æ¨¡å‹çš„é¢„æµ‹ï¼Œå¤„ç†è¾“å…¥æ•°æ®å¹¶è¿”å›å…³é”®ç‚¹æ£€æµ‹ç»“æœã€‚                 |
| `code\ultralytics\nn\modules\head.py`                             | å®šä¹‰ YOLO æ¨¡å‹çš„å¤´éƒ¨ç»“æ„ï¼Œå¤„ç†æ¨¡å‹çš„è¾“å‡ºå’ŒæŸå¤±è®¡ç®—ã€‚                                            |
| `code\ultralytics\utils\callbacks\dvc.py`                         | æä¾›å›è°ƒå‡½æ•°ï¼Œç”¨äºè®­ç»ƒè¿‡ç¨‹ä¸­çš„ç›‘æ§å’Œæ—¥å¿—è®°å½•ï¼Œå¯èƒ½æ¶‰åŠæ¨¡å‹çš„ä¿å­˜å’Œæ¢å¤ã€‚                          |
| `70+ç§YOLOv8ç®—æ³•æ”¹è¿›æºç å¤§å…¨å’Œè°ƒè¯•åŠ è½½è®­ç»ƒæ•™ç¨‹ï¼ˆéå¿…è¦ï¼‰\ultralytics\nn\extra_modules\attention.py` | å®ç°æ³¨æ„åŠ›æœºåˆ¶æ¨¡å—ï¼Œå¢å¼ºæ¨¡å‹çš„ç‰¹å¾æå–èƒ½åŠ›ã€‚                                                    |
| `code\ultralytics\hub\__init__.py`                                | åˆå§‹åŒ–æ¨¡å—ï¼Œå¯èƒ½åŒ…å«æ¨¡å‹çš„åŠ è½½å’Œé…ç½®åŠŸèƒ½ã€‚                                                    |
| `70+ç§YOLOv8ç®—æ³•æ”¹è¿›æºç å¤§å…¨å’Œè°ƒè¯•åŠ è½½è®­ç»ƒæ•™ç¨‹ï¼ˆéå¿…è¦ï¼‰\ultralytics\models\fastsam\prompt.py` | å¤„ç†ä¸ FastSAM æ¨¡å‹ç›¸å…³çš„æç¤ºè¾“å…¥ï¼Œå¯èƒ½ç”¨äºäº¤äº’å¼æ¨ç†æˆ–æ•°æ®è¾“å…¥ã€‚                                |
| `code\ultralytics\models\yolo\pose\val.py`                        | è´Ÿè´£å§¿æ€ä¼°è®¡æ¨¡å‹çš„éªŒè¯ï¼Œè®¡ç®—æ¨¡å‹åœ¨éªŒè¯é›†ä¸Šçš„æ€§èƒ½æŒ‡æ ‡ã€‚                                          |
| `code\ultralytics\models\rtdetr\train.py`                         | è´Ÿè´£ RTDETR æ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ï¼Œç±»ä¼¼äº `train.py`ï¼Œä½†é’ˆå¯¹ç‰¹å®šçš„ RTDETR æ¨¡å‹ã€‚                        |

ä»¥ä¸Šè¡¨æ ¼æ€»ç»“äº†å„ä¸ªæ–‡ä»¶çš„ä¸»è¦åŠŸèƒ½ï¼Œå¸®åŠ©ç†è§£é¡¹ç›®çš„æ•´ä½“æ¶æ„å’Œå„ä¸ªæ¨¡å—ä¹‹é—´çš„å…³ç³»ã€‚

æ³¨æ„ï¼šç”±äºæ­¤åšå®¢ç¼–è¾‘è¾ƒæ—©ï¼Œä¸Šé¢â€œ11.é¡¹ç›®æ ¸å¿ƒæºç è®²è§£ï¼ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒçœ‹ä¸æ‡‚ä»£ç é€»è¾‘ï¼‰â€ä¸­éƒ¨åˆ†ä»£ç å¯èƒ½ä¼šä¼˜åŒ–å‡çº§ï¼Œä»…ä¾›å‚è€ƒå­¦ä¹ ï¼Œå®Œæ•´â€œè®­ç»ƒæºç â€ã€â€œWebå‰ç«¯ç•Œé¢â€å’Œâ€œ70+ç§åˆ›æ–°ç‚¹æºç â€ä»¥â€œ13.å®Œæ•´è®­ç»ƒ+Webå‰ç«¯ç•Œé¢+70+ç§åˆ›æ–°ç‚¹æºç ã€æ•°æ®é›†è·å–â€çš„å†…å®¹ä¸ºå‡†ã€‚

### 13.å®Œæ•´è®­ç»ƒ+Webå‰ç«¯ç•Œé¢+70+ç§åˆ›æ–°ç‚¹æºç ã€æ•°æ®é›†è·å–

![19.png](19.png)


# [ä¸‹è½½é“¾æ¥ï¼šhttps://mbd.pub/o/bread/ZpuWm5hy](https://mbd.pub/o/bread/ZpuWm5hy)